<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="QCute"><title>Rust async/await初探 ｜ 轻作</title>
<meta name=description content='1. async/await 异步函数
async fn f0() -> u32 { let f1 = f1().await; let f2 = f2().await; f1 + f2 } async fn f1() -> u32 { 1 } async fn f2() -> u32 { 2 } 生成的HIR
Playground左上角点HIR
async fn f0() -> /*impl Trait*/ #[lang = "from_generator"](move |mut _task_context| {{ let _t = { let f1 = match #[lang = "into_future"](f1()) { mut __awaitee => loop { match unsafe { #[lang = "poll"](#[lang = "new_unchecked"](&amp;mut __awaitee), #[lang = "get_context"](_task_context)) } { #[lang = "Ready"] { 0: result } => break result, #[lang = "Pending"] {} => { } } _task_context = (yield ()); }, }; let f2 = match #[lang = "into_future"](f2()) { mut __awaitee => loop { match unsafe { #[lang = "poll"](#[lang = "new_unchecked"](&amp;mut __awaitee), #[lang = "get_context"](_task_context)) } { #[lang = "Ready"] { 0: result } => break result, #[lang = "Pending"] {} => { } } _task_context = (yield ()); }, }; f1 + f2 }; _t }}) async fn f1() -> /*impl Trait*/ #[lang = "from_generator"](move |mut _task_context| { { let _t = { 1 }; _t } }) async fn f2() -> /*impl Trait*/ #[lang = "from_generator"](move |mut _task_context| { { let _t = { 2 }; _t } }) 翻译一下
'><meta name=keywords content="Hugo,theme,graphite"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=apple-touch-icon type=image/x-icon href=/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.0.1/remixicon.css><link rel=stylesheet type=text/css media=screen href=/css/highlight.min.css><link rel=stylesheet type=text/css media=screen href=/css/graphite.min.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>首页</a></li><li><a href=/categories/>分类</a></li><li><a href=/tags/>标签</a></li><li><a href=/posts/>归档</a></li><li><a href=/about/>关于</a></li><li><a href=/search/ title=搜索 id=site_search><i class=ri-search-line></i></a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://qcute.github.io/><span><img src=/images/favicon.ico></span></a></h1></div><div class=description><h1 style=float:right><a><span>轻作</span></a></h1><br><br><p class=sub_title>重拾写作的乐趣</p><div class=my_socials><a href=https://github.com/QCute title=github target=_blank><i class=ri-github-fill></i></a>
<a href=https://www.zhihu.com/people/tui-fei-er-you-ya-de-shen-shi title=zhihu target=_blank><i class=ri-zhihu-fill></i></a>
<a href type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/rust/async-await/>Rust async/await初探</a></h2><span class=date>2020.03.09</span></div><div class="post_content markdown"><h2 id=1-asyncawait>1. async/await</h2><p>异步函数</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>f0</span><span class=p>()</span><span class=w> </span>-&gt; <span class=kt>u32</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>f1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f1</span><span class=p>().</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>f2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>f2</span><span class=p>().</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>f1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>f2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>f1</span><span class=p>()</span><span class=w> </span>-&gt; <span class=kt>u32</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>f2</span><span class=p>()</span><span class=w> </span>-&gt; <span class=kt>u32</span> <span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>生成的HIR</p><blockquote><p><a href=https://play.rust-lang.org/>Playground</a>左上角点HIR</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>f0</span><span class=p>()</span><span class=w> </span>-&gt; <span class=cm>/*impl Trait*/</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[lang = </span><span class=s>&#34;from_generator&#34;</span><span class=cp>]</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>|</span><span class=k>mut</span><span class=w> </span><span class=n>_task_context</span><span class=o>|</span><span class=w> </span><span class=p>{{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>f1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=cp>#[lang = </span><span class=s>&#34;into_future&#34;</span><span class=cp>]</span><span class=p>(</span><span class=n>f1</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>mut</span><span class=w> </span><span class=n>__awaitee</span><span class=w> </span><span class=o>=&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cp>#[lang = </span><span class=s>&#34;poll&#34;</span><span class=cp>]</span><span class=p>(</span><span class=cp>#[lang = </span><span class=s>&#34;new_unchecked&#34;</span><span class=cp>]</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>__awaitee</span><span class=p>),</span><span class=w> </span><span class=cp>#[lang = </span><span class=s>&#34;get_context&#34;</span><span class=cp>]</span><span class=p>(</span><span class=n>_task_context</span><span class=p>))</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=cp>#[lang = </span><span class=s>&#34;Ready&#34;</span><span class=cp>]</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>0</span>: <span class=nc>result</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>break</span><span class=w> </span><span class=n>result</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=cp>#[lang = </span><span class=s>&#34;Pending&#34;</span><span class=cp>]</span><span class=w> </span><span class=p>{}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>_task_context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kr>yield</span><span class=w> </span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>f2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=cp>#[lang = </span><span class=s>&#34;into_future&#34;</span><span class=cp>]</span><span class=p>(</span><span class=n>f2</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>mut</span><span class=w> </span><span class=n>__awaitee</span><span class=w> </span><span class=o>=&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cp>#[lang = </span><span class=s>&#34;poll&#34;</span><span class=cp>]</span><span class=p>(</span><span class=cp>#[lang = </span><span class=s>&#34;new_unchecked&#34;</span><span class=cp>]</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>__awaitee</span><span class=p>),</span><span class=w> </span><span class=cp>#[lang = </span><span class=s>&#34;get_context&#34;</span><span class=cp>]</span><span class=p>(</span><span class=n>_task_context</span><span class=p>))</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=cp>#[lang = </span><span class=s>&#34;Ready&#34;</span><span class=cp>]</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>0</span>: <span class=nc>result</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>break</span><span class=w> </span><span class=n>result</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=cp>#[lang = </span><span class=s>&#34;Pending&#34;</span><span class=cp>]</span><span class=w> </span><span class=p>{}</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>_task_context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kr>yield</span><span class=w> </span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>f1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>f2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>_t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>f1</span><span class=p>()</span><span class=w> </span>-&gt; <span class=cm>/*impl Trait*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[lang = </span><span class=s>&#34;from_generator&#34;</span><span class=cp>]</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>|</span><span class=k>mut</span><span class=w> </span><span class=n>_task_context</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>{</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=n>_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>};</span><span class=w> </span><span class=n>_t</span><span class=w> </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>f2</span><span class=p>()</span><span class=w> </span>-&gt; <span class=cm>/*impl Trait*/</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[lang = </span><span class=s>&#34;from_generator&#34;</span><span class=cp>]</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>|</span><span class=k>mut</span><span class=w> </span><span class=n>_task_context</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>{</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=n>_t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=p>};</span><span class=w> </span><span class=n>_t</span><span class=w> </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span></code></pre></div><p>翻译一下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>f0</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>std</span>::<span class=n>future</span>::<span class=n>from_generator</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>|</span><span class=k>mut</span><span class=w> </span><span class=n>_task_context</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>f1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>std</span>::<span class=n>future</span>::<span class=n>IntoFuture</span>::<span class=n>into_future</span><span class=p>(</span><span class=n>f1</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>mut</span><span class=w> </span><span class=n>__awaitee</span><span class=w> </span><span class=o>=&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>std</span>::<span class=n>future</span>::<span class=n>Future</span>::<span class=n>poll</span><span class=p>(</span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span>::<span class=n>new_unchecked</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>__awaitee</span><span class=p>),</span><span class=w> </span><span class=n>std</span>::<span class=n>future</span>::<span class=n>get_context</span><span class=p>(</span><span class=n>_task_context</span><span class=p>))</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>std</span>::<span class=n>task</span>::<span class=n>Poll</span>::<span class=n>Ready</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>break</span><span class=w> </span><span class=n>result</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>std</span>::<span class=n>task</span>::<span class=n>Poll</span>::<span class=n>Pending</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_task_context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kr>yield</span><span class=w> </span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>f2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=n>std</span>::<span class=n>future</span>::<span class=n>IntoFuture</span>::<span class=n>into_future</span><span class=p>(</span><span class=n>f2</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>mut</span><span class=w> </span><span class=n>__awaitee</span><span class=w> </span><span class=o>=&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>match</span><span class=w> </span><span class=k>unsafe</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>std</span>::<span class=n>future</span>::<span class=n>Future</span>::<span class=n>poll</span><span class=p>(</span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span>::<span class=n>new_unchecked</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>__awaitee</span><span class=p>),</span><span class=w> </span><span class=n>std</span>::<span class=n>future</span>::<span class=n>get_context</span><span class=p>(</span><span class=n>_task_context</span><span class=p>))</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>std</span>::<span class=n>task</span>::<span class=n>Poll</span>::<span class=n>Ready</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=k>break</span><span class=w> </span><span class=n>result</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>std</span>::<span class=n>task</span>::<span class=n>Poll</span>::<span class=n>Pending</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_task_context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kr>yield</span><span class=w> </span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>f1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>f2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>f1</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>std</span>::<span class=n>future</span>::<span class=n>from_generator</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>|</span><span class=k>mut</span><span class=w> </span><span class=n>_task_context</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>f2</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>impl</span><span class=w> </span><span class=n>Future</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>std</span>::<span class=n>future</span>::<span class=n>from_generator</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>|</span><span class=k>mut</span><span class=w> </span><span class=n>_task_context</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可见, async函数/lambda/代码块等生成拥有<a href=https://doc.rust-lang.org/stable/std/future/trait.Future.html>Future</a>特性的对象, await则生成yield的循环</p><h2 id=2-yield>2. yield</h2><p>yield关键字会把代码重写成<a href=https://doc.rust-lang.org/stable/std/ops/trait.Generator.html>Generator</a>状态机</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#![feature(generators, generator_trait)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ops</span>::<span class=p>{</span><span class=n>Generator</span><span class=p>,</span><span class=w> </span><span class=n>GeneratorState</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>generator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;start&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kr>yield</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kr>yield</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;world!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>generator</span><span class=p>).</span><span class=n>resume</span><span class=p>(());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>generator</span><span class=p>).</span><span class=n>resume</span><span class=p>(());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>上述代码会生成下面类似代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ops</span>::<span class=n>Generator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>ops</span>::<span class=n>GeneratorState</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>pin</span>::<span class=n>Pin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>enum</span> <span class=nc>GeneratorStateMachine</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Enter</span><span class=p>(</span><span class=kt>i32</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Yield1</span><span class=p>(</span><span class=kt>i32</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Yield2</span><span class=p>(</span><span class=kt>i32</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Exit</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Generator</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>GeneratorStateMachine</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Yield</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>i32</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Return</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>resume</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>GeneratorState</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Yield</span><span class=p>,</span><span class=w> </span><span class=bp>Self</span>::<span class=n>Return</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// lets us get ownership over current state
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>std</span>::<span class=n>mem</span>::<span class=n>replace</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>GeneratorStateMachine</span>::<span class=n>Exit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>GeneratorStateMachine</span>::<span class=n>Enter</span><span class=p>(</span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;start&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=cm>/*---- code before yield 1 ----*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>*</span><span class=bp>self</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GeneratorStateMachine</span>::<span class=n>Yield1</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>GeneratorState</span>::<span class=n>Yield</span><span class=p>(</span><span class=n>a</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>GeneratorStateMachine</span>::<span class=n>Yield1</span><span class=p>(</span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=cm>/*----- code after yield 1 -----*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Hello&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>*</span><span class=bp>self</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GeneratorStateMachine</span>::<span class=n>Yield2</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=cm>/*----- code before yield 2 -----*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>GeneratorState</span>::<span class=n>Yielded</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>GeneratorStateMachine</span>::<span class=n>Yield2</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=cm>/*----- code after yield 2 -----*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;world!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>*</span><span class=bp>self</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GeneratorStateMachine</span>::<span class=n>Exit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>GeneratorState</span>::<span class=n>Complete</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>GeneratorStateMachine</span>::<span class=n>Exit</span><span class=w> </span><span class=o>=&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;Can&#39;t advance an exited generator!&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span>: <span class=kt>i32</span> <span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>generator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>GeneratorStateMachine</span>::<span class=n>Enter</span><span class=p>(</span><span class=n>a</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>generator</span><span class=p>).</span><span class=n>resume</span><span class=p>(());</span><span class=w> </span><span class=c1>// 1 + 2 = 3
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>Pin</span>::<span class=n>new</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>generator</span><span class=p>).</span><span class=n>resume</span><span class=p>(());</span><span class=w> </span><span class=c1>// 3 * 2 = 6
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这种实现方式的特点是, 状态对象捕获和储存变量到自身, 无需切换上下文(CPU状态保存和恢复的消耗), 无动态堆/栈分配, 完全契合rust零开销抽象的原则</p><h2 id=参考>参考</h2><blockquote><p><a href=https://doc.rust-lang.org/beta/unstable-book/language-features/generators.html>generators</a></p></blockquote></div><div class=post_footer></div></div><div class=doc_comments><div class=comments_block_title>发表评论</div><div id=comments></div></div><style>.giscus,.giscus-frame{margin-bottom:48px}</style><script src=https://giscus.app/client.js data-repo=QCute/qcute.github.io data-repo-id=R_kgDOG-5qXQ data-category=Announcements data-category-id=DIC_kwDOG-5qXc4CSRb_ data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>轻作、重拾写作的乐趣</span></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script src=/js/graphite.min.js></script><script type=text/javascript id=MathJax-script async src=https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js></script><script>MathJax={options:{skipHtmlTags:["script","noscript","style","textarea","pre"]},tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0}}</script></body></html>