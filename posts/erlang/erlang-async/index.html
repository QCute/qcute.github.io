<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="QCute"><title>Erlang异步的实现 ｜ 轻作</title>
<meta name=description content="对于Bif 使用的是BIF_TRAP宏
#define ERTS_BIF_PREP_TRAP(Export, Proc, Arity) \ do { \ (Proc)->i = (Export)->addresses[erts_active_code_ix()]; \ (Proc)->arity = (Arity); \ (Proc)->freason = TRAP; \ } while(0); #define BIF_TRAP1(Trap_, p, A0) \ do { \ Eterm* reg = erts_proc_sched_data((p))->registers->x_reg_array.d; \ ERTS_BIF_PREP_TRAP((Trap_), (p), 1); \ reg[0] = (A0); \ return THE_NON_VALUE; \ } while(0) 可见, 保存当前PC, 寄存器数和失败原因还有调用参数
beam_hot.h下call_bif指令
OpCase(call_light_bif_be): { Export *export; ErtsBifFunc bf; Eterm result; ErlHeapFragment *live_hf_end; bf = (ErtsBifFunc) I[1]; export = (Export*) I[2]; if (!((FCALLS - 1) > 0 || (FCALLS-1) > neg_o_reds)) { /* * If we have run out of reductions, do a context * switch before calling the BIF. */ c_p->arity = GET_EXPORT_ARITY(export); c_p->current = &amp;export->info.mfa; goto context_switch3; } if (ERTS_UNLIKELY(export->is_bif_traced)) { ASSERT(VALID_INSTR(*(I+3))); *E = (BeamInstr) (I+3);; do { BeamInstr dis_next; Export *ep; ep = (Export*)(export); DTRACE_GLOBAL_CALL_FROM_EXPORT(c_p, ep); SET_I(ep->addresses[erts_active_code_ix()]); CHECK_ARGS(I); dis_next = *I; if (ERTS_UNLIKELY(FCALLS <= 0)) { if (ERTS_PROC_GET_SAVED_CALLS_BUF(c_p) && FCALLS > neg_o_reds) { save_calls(c_p, ep); } else { goto context_switch; } } FCALLS--; Goto(dis_next); } while (0); } ERTS_MSACC_SET_BIF_STATE_CACHED_X(GET_EXPORT_MODULE(export), bf); PRE_BIF_SWAPOUT(c_p); ERTS_DBG_CHK_REDS(c_p, FCALLS); c_p->fcalls = FCALLS - 1; if (FCALLS <= 0) { save_calls(c_p, export); } ASSERT(!ERTS_PROC_IS_EXITING(c_p)); ERTS_VERIFY_UNUSED_TEMP_ALLOC(c_p); live_hf_end = c_p->mbuf; ERTS_CHK_MBUF_SZ(c_p); result = (*bf)(c_p, reg, I); // 调用 /* Only heavy BIFs may GC. */ ASSERT(E == c_p->stop); ERTS_CHK_MBUF_SZ(c_p); ASSERT(!ERTS_PROC_IS_EXITING(c_p) || is_non_value(result)); ERTS_VERIFY_UNUSED_TEMP_ALLOC(c_p); ERTS_HOLE_CHECK(c_p); ERTS_REQ_PROC_MAIN_LOCK(c_p); if (ERTS_IS_GC_AFTER_BIF_DESIRED(c_p)) { Uint arity = GET_EXPORT_ARITY(export); result = erts_gc_after_bif_call_lhf(c_p, live_hf_end, result, reg, arity); E = c_p->stop; } HTOP = HEAP_TOP(c_p); FCALLS = c_p->fcalls; PROCESS_MAIN_CHK_LOCKS(c_p); ERTS_DBG_CHK_REDS(c_p, FCALLS); /* * We have to update the cache if we are enabled in order * to make sure no bookkeeping is done after we disabled * msacc. We don't always do this as it is quite expensive. */ if (ERTS_MSACC_IS_ENABLED_CACHED_X()) { ERTS_MSACC_UPDATE_CACHE_X(); } ERTS_MSACC_SET_STATE_CACHED_M_X(ERTS_MSACC_STATE_EMULATOR); if (ERTS_LIKELY(is_value(result))) { r(0) = result; CHECK_TERM(r(0)); SET_I((BeamInstr *) I+3); Goto(*I);; } else if (c_p->freason == TRAP) { // 失败原因是trap的情况 /* * Set the continuation pointer to return to next * instruction after the trap (either by a return from * erlang code or by nif_bif.epilogue() when the BIF * is done). */ ASSERT(VALID_INSTR(*(I+3))); *E = (BeamInstr) (I+3);; SET_I(c_p->i); do { BeamInstr dis_next; dis_next = *I; CHECK_ARGS(I); if (FCALLS > 0 || FCALLS > neg_o_reds) { // 还有REDS, 继续 FCALLS--; Goto(dis_next); } else { // 没有则切换上下文 goto context_switch; } } while (0); } /* * Error handling. SWAPOUT is not needed because it was done above. */ ASSERT(c_p->stop == E); I = handle_error(c_p, I, reg, &amp;export->info.mfa); goto post_error_handling; ASSERT(!&#34;Fell through 'call_light_bif' (-no_next)&#34;); } 对于Nif 使用的是YCF, YCF是一个源码转换工具, 使c语言支持yield功能, 相比其他有栈协程库, 它不需要保存调用栈
"><meta name=keywords content="Hugo,theme,graphite"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=apple-touch-icon type=image/x-icon href=/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.0.1/remixicon.css><link rel=stylesheet type=text/css media=screen href=/css/highlight.min.css><link rel=stylesheet type=text/css media=screen href=/css/graphite.min.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>首页</a></li><li><a href=/categories/>分类</a></li><li><a href=/tags/>标签</a></li><li><a href=/posts/>归档</a></li><li><a href=/about/>关于</a></li><li><a href=/search/ title=搜索 id=site_search><i class=ri-search-line></i></a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://qcute.github.io/><span><img src=/images/favicon.ico></span></a></h1></div><div class=description><h1 style=float:right><a><span>轻作</span></a></h1><br><br><p class=sub_title>重拾写作的乐趣</p><div class=my_socials><a href=https://github.com/QCute title=github target=_blank><i class=ri-github-fill></i></a>
<a href=https://www.zhihu.com/people/tui-fei-er-you-ya-de-shen-shi title=zhihu target=_blank><i class=ri-zhihu-fill></i></a>
<a href type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/erlang/erlang-async/>Erlang异步的实现</a></h2><i class="icon ri-time-line"></i>
<span class=date>2020.03.04</span></div><div class="post_content markdown"><h2 id=对于bif>对于Bif</h2><p>使用的是<a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/bif.h#L390-L432>BIF_TRAP</a>宏</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define ERTS_BIF_PREP_TRAP(Export, Proc, Arity)                               \
</span></span></span><span class=line><span class=cl><span class=cp>    do {                                                                      \
</span></span></span><span class=line><span class=cl><span class=cp>        (Proc)-&gt;i = (Export)-&gt;addresses[erts_active_code_ix()];               \
</span></span></span><span class=line><span class=cl><span class=cp>        (Proc)-&gt;arity = (Arity);                                              \
</span></span></span><span class=line><span class=cl><span class=cp>        (Proc)-&gt;freason = TRAP;                                               \
</span></span></span><span class=line><span class=cl><span class=cp>    } while(0);
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define BIF_TRAP1(Trap_, p, A0)                                               \
</span></span></span><span class=line><span class=cl><span class=cp>    do {                                                                      \
</span></span></span><span class=line><span class=cl><span class=cp>        Eterm* reg = erts_proc_sched_data((p))-&gt;registers-&gt;x_reg_array.d;     \
</span></span></span><span class=line><span class=cl><span class=cp>        ERTS_BIF_PREP_TRAP((Trap_), (p), 1);                                  \
</span></span></span><span class=line><span class=cl><span class=cp>        reg[0] = (A0);                                                        \
</span></span></span><span class=line><span class=cl><span class=cp>        return THE_NON_VALUE;                                                 \
</span></span></span><span class=line><span class=cl><span class=cp>    } while(0)
</span></span></span></code></pre></div><p>可见, 保存当前<a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/erl_process.h#L1027>PC</a>, <a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/erl_process.h#L1020>寄存器数</a>和<a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/erl_process.h#L1004>失败原因</a>还有调用参数</p><p><a href>beam_hot.h</a>下call_bif指令</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>OpCase</span><span class=p>(</span><span class=n>call_light_bif_be</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Export</span> <span class=o>*</span><span class=n>export</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>ErtsBifFunc</span> <span class=n>bf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>Eterm</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>ErlHeapFragment</span> <span class=o>*</span><span class=n>live_hf_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>bf</span> <span class=o>=</span> <span class=p>(</span><span class=n>ErtsBifFunc</span><span class=p>)</span> <span class=n>I</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>export</span> <span class=o>=</span> <span class=p>(</span><span class=n>Export</span><span class=o>*</span><span class=p>)</span> <span class=n>I</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>((</span><span class=n>FCALLS</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=p>(</span><span class=n>FCALLS</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>neg_o_reds</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    * If we have run out of reductions, do a context
</span></span></span><span class=line><span class=cl><span class=cm>    * switch before calling the BIF.
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>    <span class=n>c_p</span><span class=o>-&gt;</span><span class=n>arity</span> <span class=o>=</span> <span class=nf>GET_EXPORT_ARITY</span><span class=p>(</span><span class=n>export</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>c_p</span><span class=o>-&gt;</span><span class=n>current</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>export</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>.</span><span class=n>mfa</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>goto</span> <span class=n>context_switch3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>ERTS_UNLIKELY</span><span class=p>(</span><span class=n>export</span><span class=o>-&gt;</span><span class=n>is_bif_traced</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>ASSERT</span><span class=p>(</span><span class=nf>VALID_INSTR</span><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=n>I</span><span class=o>+</span><span class=mi>3</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>E</span> <span class=o>=</span> <span class=p>(</span><span class=n>BeamInstr</span><span class=p>)</span> <span class=p>(</span><span class=n>I</span><span class=o>+</span><span class=mi>3</span><span class=p>);;</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>BeamInstr</span> <span class=n>dis_next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>Export</span> <span class=o>*</span><span class=n>ep</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>ep</span> <span class=o>=</span> <span class=p>(</span><span class=n>Export</span><span class=o>*</span><span class=p>)(</span><span class=n>export</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nf>DTRACE_GLOBAL_CALL_FROM_EXPORT</span><span class=p>(</span><span class=n>c_p</span><span class=p>,</span> <span class=n>ep</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nf>SET_I</span><span class=p>(</span><span class=n>ep</span><span class=o>-&gt;</span><span class=n>addresses</span><span class=p>[</span><span class=nf>erts_active_code_ix</span><span class=p>()]);</span>
</span></span><span class=line><span class=cl>      <span class=nf>CHECK_ARGS</span><span class=p>(</span><span class=n>I</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>dis_next</span> <span class=o>=</span> <span class=o>*</span><span class=n>I</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nf>ERTS_UNLIKELY</span><span class=p>(</span><span class=n>FCALLS</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>ERTS_PROC_GET_SAVED_CALLS_BUF</span><span class=p>(</span><span class=n>c_p</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>FCALLS</span> <span class=o>&gt;</span> <span class=n>neg_o_reds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>save_calls</span><span class=p>(</span><span class=n>c_p</span><span class=p>,</span> <span class=n>ep</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>goto</span> <span class=n>context_switch</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>FCALLS</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>Goto</span><span class=p>(</span><span class=n>dis_next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>ERTS_MSACC_SET_BIF_STATE_CACHED_X</span><span class=p>(</span><span class=nf>GET_EXPORT_MODULE</span><span class=p>(</span><span class=n>export</span><span class=p>),</span> <span class=n>bf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>PRE_BIF_SWAPOUT</span><span class=p>(</span><span class=n>c_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>ERTS_DBG_CHK_REDS</span><span class=p>(</span><span class=n>c_p</span><span class=p>,</span> <span class=n>FCALLS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>c_p</span><span class=o>-&gt;</span><span class=n>fcalls</span> <span class=o>=</span> <span class=n>FCALLS</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>FCALLS</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>save_calls</span><span class=p>(</span><span class=n>c_p</span><span class=p>,</span> <span class=n>export</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>ASSERT</span><span class=p>(</span><span class=o>!</span><span class=nf>ERTS_PROC_IS_EXITING</span><span class=p>(</span><span class=n>c_p</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=nf>ERTS_VERIFY_UNUSED_TEMP_ALLOC</span><span class=p>(</span><span class=n>c_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>live_hf_end</span> <span class=o>=</span> <span class=n>c_p</span><span class=o>-&gt;</span><span class=n>mbuf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>ERTS_CHK_MBUF_SZ</span><span class=p>(</span><span class=n>c_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=n>bf</span><span class=p>)(</span><span class=n>c_p</span><span class=p>,</span> <span class=n>reg</span><span class=p>,</span> <span class=n>I</span><span class=p>);</span>    <span class=c1>// 调用
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Only heavy BIFs may GC. */</span>
</span></span><span class=line><span class=cl>  <span class=nf>ASSERT</span><span class=p>(</span><span class=n>E</span> <span class=o>==</span> <span class=n>c_p</span><span class=o>-&gt;</span><span class=n>stop</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>ERTS_CHK_MBUF_SZ</span><span class=p>(</span><span class=n>c_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>ASSERT</span><span class=p>(</span><span class=o>!</span><span class=nf>ERTS_PROC_IS_EXITING</span><span class=p>(</span><span class=n>c_p</span><span class=p>)</span> <span class=o>||</span> <span class=nf>is_non_value</span><span class=p>(</span><span class=n>result</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=nf>ERTS_VERIFY_UNUSED_TEMP_ALLOC</span><span class=p>(</span><span class=n>c_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>ERTS_HOLE_CHECK</span><span class=p>(</span><span class=n>c_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>ERTS_REQ_PROC_MAIN_LOCK</span><span class=p>(</span><span class=n>c_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>ERTS_IS_GC_AFTER_BIF_DESIRED</span><span class=p>(</span><span class=n>c_p</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Uint</span> <span class=n>arity</span> <span class=o>=</span> <span class=nf>GET_EXPORT_ARITY</span><span class=p>(</span><span class=n>export</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=nf>erts_gc_after_bif_call_lhf</span><span class=p>(</span><span class=n>c_p</span><span class=p>,</span> <span class=n>live_hf_end</span><span class=p>,</span> <span class=n>result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>reg</span><span class=p>,</span> <span class=n>arity</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>E</span> <span class=o>=</span> <span class=n>c_p</span><span class=o>-&gt;</span><span class=n>stop</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>HTOP</span> <span class=o>=</span> <span class=nf>HEAP_TOP</span><span class=p>(</span><span class=n>c_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>FCALLS</span> <span class=o>=</span> <span class=n>c_p</span><span class=o>-&gt;</span><span class=n>fcalls</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>PROCESS_MAIN_CHK_LOCKS</span><span class=p>(</span><span class=n>c_p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>ERTS_DBG_CHK_REDS</span><span class=p>(</span><span class=n>c_p</span><span class=p>,</span> <span class=n>FCALLS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>  * We have to update the cache if we are enabled in order
</span></span></span><span class=line><span class=cl><span class=cm>  * to make sure no bookkeeping is done after we disabled
</span></span></span><span class=line><span class=cl><span class=cm>  * msacc. We don&#39;t always do this as it is quite expensive.
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>ERTS_MSACC_IS_ENABLED_CACHED_X</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>ERTS_MSACC_UPDATE_CACHE_X</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>ERTS_MSACC_SET_STATE_CACHED_M_X</span><span class=p>(</span><span class=n>ERTS_MSACC_STATE_EMULATOR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>ERTS_LIKELY</span><span class=p>(</span><span class=nf>is_value</span><span class=p>(</span><span class=n>result</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>r</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>=</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>CHECK_TERM</span><span class=p>(</span><span class=nf>r</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>SET_I</span><span class=p>((</span><span class=n>BeamInstr</span> <span class=o>*</span><span class=p>)</span> <span class=n>I</span><span class=o>+</span><span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>Goto</span><span class=p>(</span><span class=o>*</span><span class=n>I</span><span class=p>);;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>c_p</span><span class=o>-&gt;</span><span class=n>freason</span> <span class=o>==</span> <span class=n>TRAP</span><span class=p>)</span> <span class=p>{</span>    <span class=c1>// 失败原因是trap的情况
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    * Set the continuation pointer to return to next
</span></span></span><span class=line><span class=cl><span class=cm>    * instruction after the trap (either by a return from
</span></span></span><span class=line><span class=cl><span class=cm>    * erlang code or by nif_bif.epilogue() when the BIF
</span></span></span><span class=line><span class=cl><span class=cm>    * is done).
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>    <span class=nf>ASSERT</span><span class=p>(</span><span class=nf>VALID_INSTR</span><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=n>I</span><span class=o>+</span><span class=mi>3</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>E</span> <span class=o>=</span> <span class=p>(</span><span class=n>BeamInstr</span><span class=p>)</span> <span class=p>(</span><span class=n>I</span><span class=o>+</span><span class=mi>3</span><span class=p>);;</span>
</span></span><span class=line><span class=cl>    <span class=nf>SET_I</span><span class=p>(</span><span class=n>c_p</span><span class=o>-&gt;</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>BeamInstr</span> <span class=n>dis_next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>dis_next</span> <span class=o>=</span> <span class=o>*</span><span class=n>I</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>CHECK_ARGS</span><span class=p>(</span><span class=n>I</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>FCALLS</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>FCALLS</span> <span class=o>&gt;</span> <span class=n>neg_o_reds</span><span class=p>)</span> <span class=p>{</span>    <span class=c1>// 还有REDS, 继续
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>FCALLS</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>Goto</span><span class=p>(</span><span class=n>dis_next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>                                    <span class=c1>// 没有则切换上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>goto</span> <span class=n>context_switch</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>  * Error handling.  SWAPOUT is not needed because it was done above.
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl>  <span class=nf>ASSERT</span><span class=p>(</span><span class=n>c_p</span><span class=o>-&gt;</span><span class=n>stop</span> <span class=o>==</span> <span class=n>E</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>I</span> <span class=o>=</span> <span class=nf>handle_error</span><span class=p>(</span><span class=n>c_p</span><span class=p>,</span> <span class=n>I</span><span class=p>,</span> <span class=n>reg</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>export</span><span class=o>-&gt;</span><span class=n>info</span><span class=p>.</span><span class=n>mfa</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>goto</span> <span class=n>post_error_handling</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>ASSERT</span><span class=p>(</span><span class=o>!</span><span class=s>&#34;Fell through &#39;call_light_bif&#39; (-no_next)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=对于nif>对于Nif</h2><p>使用的是<a href=https://github.com/erlang/otp/blob/maint-24/erts/lib_src/yielding_c_fun/README.md>YCF</a>, YCF是一个源码转换工具, 使c语言支持yield功能, 相比其他有栈协程库, 它不需要保存调用栈</p></div><div class=post_footer></div></div><div class=doc_comments><div class=comments_block_title>发表评论</div><div id=comments></div></div><style>.giscus,.giscus-frame{margin-bottom:48px}</style><script src=https://giscus.app/client.js data-repo=QCute/qcute.github.io data-repo-id=R_kgDOG-5qXQ data-category=Announcements data-category-id=DIC_kwDOG-5qXc4CSRb_ data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=statistics><i class=ri-article-line></i>
<span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span>
</span><i class=ri-bar-chart-box-line></i>
<span id=busuanzi_container_site_pv><span id=busuanzi_value_site_pv></span></span></div><div class=footer_slogan><span>轻作 | 重拾写作的乐趣</span></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script src=/js/graphite.min.js></script><script src=https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script type=text/javascript id=MathJax-script async src=https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js></script><script>MathJax={options:{skipHtmlTags:["script","noscript","style","textarea","pre"]},tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0}}</script></body></html>