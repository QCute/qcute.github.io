<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="VarKai"><title>Erlang更新Record的优化 ｜ 轻作</title><meta name=description content="Record的更新使用的是erlang:setelement/3, 在更新多个字段的时候很浪费性能以及内存 后来引入了一个破坏性的优化指令: set_tuple_element -record(record, {a, b, c, d, e, f}). update(R) -&amp;gt; R#record{a = 1, b = 2}. {function, update, 1, 8}. {label,7}. {line,[{location,&amp;#34;test.erl&amp;#34;,3}]}. {func_info,{atom,user_default},{atom,update},1}. {label,8}. {test,is_tagged_tuple,{f,9},[{x,0},7,{atom,record}]}. {allocate,0,1}. {move,{x,0},{x,1}}. {move,{integer,2},{x,2}}. {move,{integer,3},{x,0}}. {line,[{location,&amp;#34;test.erl&amp;#34;,4}]}. {call_ext,3,{extfunc,erlang,setelement,3}}. {set_tuple_element,{integer,1},{x,0},1}."><meta name=keywords content="Hugo,theme,graphite"><link rel="shortcut icon" href=https://qcute.github.io/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://qcute.github.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://qcute.github.io/css/graphite.css><link rel=stylesheet type=text/css media=screen href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=https://qcute.github.io/css/highlight.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>首页</a></li><li><a href=/categories/>分类</a></li><li><a href=/tags/>标签</a></li><li><a href=/about/>关于</a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://qcute.github.io/><span><img src=https://gohugo.io/favicon.ico></span></a></h1></div><div class=description><h1 style=float:right><a><span>轻作</span></a></h1><br><br><p class=sub_title>重拾写作的乐趣</p><div class=my_socials><a href=https://github.com/QCute title=github target=_blank><i class=ri-github-fill></i></a>
<a href=https://www.zhihu.com/people/tui-fei-er-you-ya-de-shen-shi title=zhihu target=_blank><i class=ri-zhihu-fill></i></a>
<a href=https://qcute.github.io/index.xml type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/erlang/beam-set-tuple-element/>Erlang更新Record的优化</a></h2><span class=date>2022.03.08</span></div><div class="post_content markdown"><p>Record的更新使用的是<a href=https://github.com/erlang/otp/blob/maint-24/erts/preloaded/src/erlang.erl#L2589>erlang:setelement/3</a>, 在更新多个字段的时候很浪费性能以及内存<br>后来引入了一个破坏性的优化指令: set_tuple_element</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erl data-lang=erl><span class=line><span class=cl><span class=p>-</span><span class=ni>record</span><span class=p>(</span><span class=nl>record</span><span class=p>,</span> <span class=p>{</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>f</span><span class=p>}).</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>update</span><span class=p>(</span><span class=nv>R</span><span class=p>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nv>R</span><span class=nl>#record</span><span class=p>{</span><span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>}.</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>{</span><span class=nf>function</span><span class=p>,</span> <span class=no>update</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>8</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>  <span class=err>{</span><span class=nf>label</span><span class=p>,</span><span class=mi>7</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>line</span><span class=p>,[</span><span class=err>{</span><span class=no>location</span><span class=p>,</span><span class=err>&#34;</span><span class=no>test.erl</span><span class=err>&#34;</span><span class=p>,</span><span class=mi>3</span><span class=err>}</span><span class=p>]</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>func_info</span><span class=p>,</span><span class=err>{</span><span class=no>atom</span><span class=p>,</span><span class=no>user_default</span><span class=err>}</span><span class=p>,</span><span class=err>{</span><span class=no>atom</span><span class=p>,</span><span class=no>update</span><span class=err>}</span><span class=p>,</span><span class=mi>1</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>  <span class=err>{</span><span class=nf>label</span><span class=p>,</span><span class=mi>8</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>test</span><span class=p>,</span><span class=no>is_tagged_tuple</span><span class=p>,</span><span class=err>{</span><span class=no>f</span><span class=p>,</span><span class=mi>9</span><span class=err>}</span><span class=p>,[</span><span class=err>{</span><span class=no>x</span><span class=p>,</span><span class=mi>0</span><span class=err>}</span><span class=p>,</span><span class=mi>7</span><span class=p>,</span><span class=err>{</span><span class=no>atom</span><span class=p>,</span><span class=no>record</span><span class=err>}</span><span class=p>]</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>allocate</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>move</span><span class=p>,</span><span class=err>{</span><span class=no>x</span><span class=p>,</span><span class=mi>0</span><span class=err>}</span><span class=p>,</span><span class=err>{</span><span class=no>x</span><span class=p>,</span><span class=mi>1</span><span class=err>}}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>move</span><span class=p>,</span><span class=err>{</span><span class=no>integer</span><span class=p>,</span><span class=mi>2</span><span class=err>}</span><span class=p>,</span><span class=err>{</span><span class=no>x</span><span class=p>,</span><span class=mi>2</span><span class=err>}}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>move</span><span class=p>,</span><span class=err>{</span><span class=no>integer</span><span class=p>,</span><span class=mi>3</span><span class=err>}</span><span class=p>,</span><span class=err>{</span><span class=no>x</span><span class=p>,</span><span class=mi>0</span><span class=err>}}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>line</span><span class=p>,[</span><span class=err>{</span><span class=no>location</span><span class=p>,</span><span class=err>&#34;</span><span class=no>test.erl</span><span class=err>&#34;</span><span class=p>,</span><span class=mi>4</span><span class=err>}</span><span class=p>]</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>call_ext</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=err>{</span><span class=no>extfunc</span><span class=p>,</span><span class=no>erlang</span><span class=p>,</span><span class=no>setelement</span><span class=p>,</span><span class=mi>3</span><span class=err>}}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>set_tuple_element</span><span class=p>,</span><span class=err>{</span><span class=no>integer</span><span class=p>,</span><span class=mi>1</span><span class=err>}</span><span class=p>,</span><span class=err>{</span><span class=no>x</span><span class=p>,</span><span class=mi>0</span><span class=err>}</span><span class=p>,</span><span class=mi>1</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>deallocate</span><span class=p>,</span><span class=mi>0</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=nf>return.</span>
</span></span><span class=line><span class=cl>  <span class=err>{</span><span class=nf>label</span><span class=p>,</span><span class=mi>9</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>move</span><span class=p>,</span><span class=err>{</span><span class=no>literal</span><span class=p>,</span><span class=err>{</span><span class=no>badrecord</span><span class=p>,</span><span class=no>record</span><span class=err>}}</span><span class=p>,</span><span class=err>{</span><span class=no>x</span><span class=p>,</span><span class=mi>0</span><span class=err>}}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>call_ext_only</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=err>{</span><span class=no>extfunc</span><span class=p>,</span><span class=no>erlang</span><span class=p>,</span><span class=no>error</span><span class=p>,</span><span class=mi>1</span><span class=err>}}</span><span class=p>.</span>
</span></span></code></pre></div><p>参考Github <a href=https://github.com/erlang/otp/issues>Issues</a></p><blockquote><p><a href=https://github.com/erlang/otp/pull/2146>Do the destructive setelement optimization in SSA</a></p></blockquote></div><div class=post_footer></div></div><div class=doc_comments></div></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>轻作、重拾写作的乐趣</span></div></footer><script src=https://qcute.github.io/js/jquery-3.5.1.min.js></script>
<link href=https://qcute.github.io/css/fancybox.min.css rel=stylesheet><script src=https://qcute.github.io/js/fancybox.min.js></script>
<script src=https://qcute.github.io/js/graphite.js></script>
<script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style></body></html>