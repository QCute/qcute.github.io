<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="VarKai"><title>Erlang函数调用方式性能 ｜ 轻作</title>
<meta name=description content="老生常谈的, 包括Myths, 下面测试下几种调用方式的性能差距。 test_apply() -&amp;gt; L = lists:seq(1, 10000000), LocalTime = os:timestamp(), [jp() || _ &amp;lt;- L], RemoteTime = os:timestamp(), [?MODULE:jp() || _ &amp;lt;- L], ApplyTime = os:timestamp(), [apply(?MODULE, jp, []) || _ &amp;lt;- L], ExecuteTime = os:timestamp(), Module = ?MODULE, Function = jp, [Module:Function() || _ &amp;lt;- L], ApplyFunctionTime = os:timestamp(), [apply(fun ?MODULE:jp/0, []) || _ &amp;lt;- L], ExecuteFunctionTime = os:timestamp(), F = fun ?MODULE:jp/0, [F() || _ &amp;lt;- L], LambdaFunctionTime"><meta name=keywords content="Hugo,theme,graphite"><link rel="shortcut icon" href=https://qcute.github.io/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://unpkg.com/normalize.css@8.0.1/normalize.css><link rel=stylesheet type=text/css media=screen href=https://unpkg.com/animate.css@4.1.1/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://unpkg.com/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=https://unpkg.com/@fancyapps/ui@4.0.27/dist/fancybox.css><link rel=stylesheet type=text/css media=screen href=/css/highlight.min.css><link rel=stylesheet type=text/css media=screen href=/css/graphite.min.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>首页</a></li><li><a href=/categories/>分类</a></li><li><a href=/tags/>标签</a></li><li><a href=/posts/>归档</a></li><li><a href=/about/>关于</a></li><li><a href=/search/ title=搜索 id=site_search><i class=ri-search-line></i></a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://qcute.github.io/><span><img src=https://gohugo.io/favicon.ico></span></a></h1></div><div class=description><h1 style=float:right><a><span>轻作</span></a></h1><br><br><p class=sub_title>重拾写作的乐趣</p><div class=my_socials><a href=https://github.com/QCute title=github target=_blank><i class=ri-github-fill></i></a>
<a href=https://www.zhihu.com/people/tui-fei-er-you-ya-de-shen-shi title=zhihu target=_blank><i class=ri-zhihu-fill></i></a>
<a href type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/erlang/apply/>Erlang函数调用方式性能</a></h2><span class=date>2020.03.04</span></div><div class="post_content markdown"><p>老生常谈的, 包括<a href=https://www.erlang.org/doc/efficiency_guide/retired_myths#myth--funs-are-slow>Myths</a>, 下面测试下几种调用方式的性能差距。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-erl data-lang=erl><span class=line><span class=cl><span class=nf>test_apply</span><span class=p>()</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nv>L</span> <span class=o>=</span> <span class=nn>lists</span><span class=p>:</span><span class=nf>seq</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>10000000</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nv>LocalTime</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=n>jp</span><span class=p>()</span> <span class=p>||</span> <span class=p>_</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nv>RemoteTime</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=o>?</span><span class=nv>MODULE</span><span class=p>:</span><span class=nf>jp</span><span class=p>()</span> <span class=p>||</span> <span class=p>_</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nv>ApplyTime</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>apply</span><span class=p>(</span><span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span> <span class=n>jp</span><span class=p>,</span> <span class=p>[])</span> <span class=p>||</span> <span class=p>_</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nv>ExecuteTime</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nv>Module</span> <span class=o>=</span> <span class=o>?</span><span class=nv>MODULE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nv>Function</span> <span class=o>=</span> <span class=n>jp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nv>Module</span><span class=p>:</span><span class=nv>Function</span><span class=p>()</span> <span class=p>||</span> <span class=p>_</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nv>ApplyFunctionTime</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>apply</span><span class=p>(</span><span class=k>fun</span> <span class=o>?</span><span class=nv>MODULE</span><span class=p>:</span><span class=n>jp</span><span class=o>/</span><span class=mi>0</span><span class=p>,</span> <span class=p>[])</span> <span class=p>||</span> <span class=p>_</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nv>ExecuteFunctionTime</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nv>F</span> <span class=o>=</span> <span class=k>fun</span> <span class=o>?</span><span class=nv>MODULE</span><span class=p>:</span><span class=n>jp</span><span class=o>/</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nv>F</span><span class=p>()</span> <span class=p>||</span> <span class=p>_</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nv>LambdaFunctionTime</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nv>FF</span> <span class=o>=</span> <span class=k>fun</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=s>&#34;にほんご&#34;</span> <span class=k>end</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nb>apply</span><span class=p>(</span><span class=nv>FF</span><span class=p>,</span> <span class=p>[])</span> <span class=p>||</span> <span class=p>_</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nv>EndTime</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nn>io</span><span class=p>:</span><span class=nf>format</span><span class=p>(</span><span class=s>&#34;Local:</span><span class=si>~p</span><span class=s> Remote:</span><span class=si>~p</span><span class=s> Apply(M,F,A):</span><span class=si>~p</span><span class=s> M:F(A):</span><span class=si>~p</span><span class=s> Apply(fun,A):</span><span class=si>~p</span><span class=s> F:(A):</span><span class=si>~p</span><span class=s> FF(A):</span><span class=si>~p~n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>[</span><span class=nn>timer</span><span class=p>:</span><span class=nf>now_diff</span><span class=p>(</span><span class=nv>RemoteTime</span><span class=p>,</span> <span class=nv>LocalTime</span><span class=p>),</span> <span class=nn>timer</span><span class=p>:</span><span class=nf>now_diff</span><span class=p>(</span><span class=nv>ApplyTime</span><span class=p>,</span> <span class=nv>RemoteTime</span><span class=p>),</span> <span class=nn>timer</span><span class=p>:</span><span class=nf>now_diff</span><span class=p>(</span><span class=nv>ExecuteTime</span><span class=p>,</span> <span class=nv>ApplyTime</span><span class=p>),</span> <span class=nn>timer</span><span class=p>:</span><span class=nf>now_diff</span><span class=p>(</span><span class=nv>ApplyFunctionTime</span><span class=p>,</span> <span class=nv>ExecuteTime</span><span class=p>),</span> <span class=nn>timer</span><span class=p>:</span><span class=nf>now_diff</span><span class=p>(</span><span class=nv>ExecuteFunctionTime</span><span class=p>,</span> <span class=nv>ApplyFunctionTime</span><span class=p>),</span> <span class=nn>timer</span><span class=p>:</span><span class=nf>now_diff</span><span class=p>(</span><span class=nv>LambdaFunctionTime</span><span class=p>,</span> <span class=nv>ExecuteFunctionTime</span><span class=p>),</span> <span class=nn>timer</span><span class=p>:</span><span class=nf>now_diff</span><span class=p>(</span><span class=nv>EndTime</span><span class=p>,</span> <span class=nv>LambdaFunctionTime</span><span class=p>)]),</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>more_test</span><span class=p>()</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nv>L</span> <span class=o>=</span> <span class=nn>lists</span><span class=p>:</span><span class=nf>seq</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1000</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=n>test</span><span class=p>()</span> <span class=p>||</span> <span class=p>_</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=nf>test</span><span class=p>()</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nv>O</span> <span class=o>=</span> <span class=mi>10000000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nv>L</span> <span class=o>=</span> <span class=nn>lists</span><span class=p>:</span><span class=nf>seq</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nv>O</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nv>Begin</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=c>%% first
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nv>F</span> <span class=o>=</span> <span class=k>fun</span> <span class=n>jp</span><span class=o>/</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=nv>F</span><span class=p>()</span> <span class=p>||</span> <span class=p>_</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=c>%% [?MODULE:jp() || _ &lt;- L],
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>%% middle
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nv>Middle</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=c>%% middle
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=p>[</span><span class=nb>apply</span><span class=p>(</span><span class=k>fun</span> <span class=n>jp</span><span class=o>/</span><span class=mi>0</span><span class=p>,</span> <span class=p>[])</span> <span class=p>||</span> <span class=p>_</span> <span class=o>&lt;-</span> <span class=nv>L</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=c>%% [apply(?MODULE, jp, []) || _ &lt;- L],
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>%% [?MODULE:jp() || _ &lt;- L],
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=c>%% second
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nv>End</span> <span class=o>=</span> <span class=nn>os</span><span class=p>:</span><span class=nf>timestamp</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=c>%% diff
</span></span></span><span class=line><span class=cl><span class=c></span>    <span class=nv>First</span> <span class=o>=</span> <span class=nn>timer</span><span class=p>:</span><span class=nf>now_diff</span><span class=p>(</span><span class=nv>Middle</span><span class=p>,</span> <span class=nv>Begin</span><span class=p>)</span> <span class=ow>div</span> <span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nv>Second</span> <span class=o>=</span> <span class=nn>timer</span><span class=p>:</span><span class=nf>now_diff</span><span class=p>(</span><span class=nv>End</span><span class=p>,</span> <span class=nv>Middle</span><span class=p>)</span> <span class=ow>div</span> <span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nn>io</span><span class=p>:</span><span class=nf>format</span><span class=p>(</span><span class=s>&#34;First:</span><span class=si>~p</span><span class=s>   Second:</span><span class=si>~p~n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>[</span><span class=nv>First</span><span class=p>,</span> <span class=nv>Second</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>%% にほんご
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>jp</span><span class=p>()</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;にほんご&#34;</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=nf>jps</span><span class=p>()</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>    <span class=o>&lt;&lt;</span><span class=s>&#34;にほんご&#34;</span><span class=o>/</span><span class=n>utf8</span><span class=o>&gt;&gt;</span><span class=p>.</span>
</span></span></code></pre></div><h3 id=时间如下-测试环境为otp-24jit>时间如下, 测试环境为<a href>OTP-24(JIT)</a></h3><table><thead><tr><th>Method</th><th>Time</th><th>Time</th><th>Time</th></tr></thead><tbody><tr><td>Local</td><td>36371</td><td>34962</td><td>35632</td></tr><tr><td>Remote</td><td>38037</td><td>37300</td><td>37544</td></tr><tr><td>apply(M,F,A)</td><td>38141</td><td>38635</td><td>38756</td></tr><tr><td>M:F(A)</td><td>36348</td><td>36603</td><td>35734</td></tr><tr><td>apply(fun,A)</td><td>36422</td><td>36082</td><td>35405</td></tr><tr><td>F(A)</td><td>36588</td><td>36039</td><td>35686</td></tr><tr><td>FF(A)</td><td>83646</td><td>78447</td><td>72395</td></tr></tbody></table><h3 id=结论>结论</h3><p>可见, 前几种调用方式差距不算很大, 只是最后apply lambda函数的情况下差距较大。在<a href>OTP-24 with (JIT)</a>之后, 想要抽象也不需要付出很大的性能代价, 放心尽情地使用吧。</p></div><div class=post_footer></div></div><div class=doc_comments><div class=comments_block_title>发表评论</div><div id=comments></div></div><style>.giscus,.giscus-frame{margin-bottom:48px}</style><script src=https://giscus.app/client.js data-repo=QCute/qcute.github.io data-repo-id=R_kgDOG-5qXQ data-category=Announcements data-category-id=DIC_kwDOG-5qXc4CSRb_ data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>轻作、重拾写作的乐趣</span></div></footer><script src=https://unpkg.com/elevator.js@1.0.1/elevator.min.js></script><script src=https://unpkg.com/dom-slider@2.1.6/dist/dom-slider.js></script><script src=https://unpkg.com/@fancyapps/ui@4.0.27/dist/fancybox.umd.js></script><script src=/js/graphite.min.js></script><script>MathJax={options:{skipHtmlTags:["script","noscript","style","textarea","pre"]},tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0}}</script><script type=text/javascript id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js></script></body></html>