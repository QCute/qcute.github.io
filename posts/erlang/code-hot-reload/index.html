<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="QCute"><title>Erlang热更新的实现 ｜ 轻作</title>
<meta name=description content='从一个基本调用开始 {function, call, 0, 2}. {label,1}. {line,[{location,"src/examples/test/test.erl",9}]}. {func_info,{atom,test},{atom,call},0}. {label,2}. {move,{atom,c},{x,0}}. {line,[{location,"src/examples/test/test.erl",10}]}. {call_ext_only,1,{extfunc,a,b,1}}. call_ext_only指令位于beam_hot.h文件，在编译时使用ops.tab文件生成
接下来看下指令代码
OpCase(i_call_ext_last_eQ): { E = ADD_BYTE_OFFSET(E, I[2]);; do { BeamInstr dis_next; Export *ep; ep = (Export*)(I[1]); DTRACE_GLOBAL_CALL_FROM_EXPORT(c_p, ep); SET_I(ep->dispatch.addresses[erts_active_code_ix()]); CHECK_ARGS(I); dis_next = *I; if (ERTS_UNLIKELY(FCALLS <= 0)) { if (ERTS_PROC_GET_SAVED_CALLS_BUF(c_p) && FCALLS > neg_o_reds) { save_calls(c_p, ep); } else { goto context_switch; } } FCALLS--; Goto(dis_next); } while (0);ASSERT(!"Fell through &#39;i_call_ext_last&#39; (-no_next)"); } Export导出结构和erts_active_code_ix激活代码地址索引是我们想要了解的
'><meta name=keywords content="Hugo,theme,graphite"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=apple-touch-icon type=image/x-icon href=/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.0.1/remixicon.css><link rel=stylesheet type=text/css media=screen href=/css/highlight.min.css><link rel=stylesheet type=text/css media=screen href=/css/graphite.min.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>首页</a></li><li><a href=/categories/>分类</a></li><li><a href=/tags/>标签</a></li><li><a href=/posts/>归档</a></li><li><a href=/about/>关于</a></li><li><a href=/search/ title=搜索 id=site_search><i class=ri-search-line></i></a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://qcute.github.io/><span><img src=/images/favicon.ico></span></a></h1></div><div class=description><h1 style=float:right><a><span>轻作</span></a></h1><br><br><p class=sub_title>重拾写作的乐趣</p><div class=my_socials><a href=https://github.com/QCute title=github target=_blank><i class=ri-github-fill></i></a>
<a href=https://www.zhihu.com/people/tui-fei-er-you-ya-de-shen-shi title=zhihu target=_blank><i class=ri-zhihu-fill></i></a>
<a href type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/erlang/code-hot-reload/>Erlang热更新的实现</a></h2><span class=date>2020.03.04</span></div><div class="post_content markdown"><h2 id=从一个基本调用开始>从一个基本调用开始</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=err>{</span><span class=nf>function</span><span class=p>,</span> <span class=no>call</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>  <span class=err>{</span><span class=nf>label</span><span class=p>,</span><span class=mi>1</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>line</span><span class=p>,[</span><span class=err>{</span><span class=no>location</span><span class=p>,</span><span class=err>&#34;</span><span class=no>src</span><span class=err>/</span><span class=no>examples</span><span class=err>/</span><span class=no>test</span><span class=err>/</span><span class=no>test.erl</span><span class=err>&#34;</span><span class=p>,</span><span class=mi>9</span><span class=err>}</span><span class=p>]</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>func_info</span><span class=p>,</span><span class=err>{</span><span class=no>atom</span><span class=p>,</span><span class=no>test</span><span class=err>}</span><span class=p>,</span><span class=err>{</span><span class=no>atom</span><span class=p>,</span><span class=no>call</span><span class=err>}</span><span class=p>,</span><span class=mi>0</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>  <span class=err>{</span><span class=nf>label</span><span class=p>,</span><span class=mi>2</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>move</span><span class=p>,</span><span class=err>{</span><span class=no>atom</span><span class=p>,</span><span class=no>c</span><span class=err>}</span><span class=p>,</span><span class=err>{</span><span class=no>x</span><span class=p>,</span><span class=mi>0</span><span class=err>}}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>line</span><span class=p>,[</span><span class=err>{</span><span class=no>location</span><span class=p>,</span><span class=err>&#34;</span><span class=no>src</span><span class=err>/</span><span class=no>examples</span><span class=err>/</span><span class=no>test</span><span class=err>/</span><span class=no>test.erl</span><span class=err>&#34;</span><span class=p>,</span><span class=mi>10</span><span class=err>}</span><span class=p>]</span><span class=err>}</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=err>{</span><span class=nf>call_ext_only</span><span class=p>,</span><span class=mi>1</span><span class=p>,</span><span class=err>{</span><span class=no>extfunc</span><span class=p>,</span><span class=no>a</span><span class=p>,</span><span class=no>b</span><span class=p>,</span><span class=mi>1</span><span class=err>}}</span><span class=p>.</span>
</span></span></code></pre></div><p><code>call_ext_only</code>指令位于<a href=erts/emulator/x86_64-pc-linux-gnu/opt/emu/beam_hot.h>beam_hot.h</a>文件，在编译时使用<a href=erts/emulator/beam/emu/ops.tab>ops.tab</a>文件生成</p><p>接下来看下指令代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>OpCase</span><span class=p>(</span><span class=n>i_call_ext_last_eQ</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>E</span> <span class=o>=</span> <span class=nf>ADD_BYTE_OFFSET</span><span class=p>(</span><span class=n>E</span><span class=p>,</span> <span class=n>I</span><span class=p>[</span><span class=mi>2</span><span class=p>]);;</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>BeamInstr</span> <span class=n>dis_next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Export</span> <span class=o>*</span><span class=n>ep</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ep</span> <span class=o>=</span> <span class=p>(</span><span class=n>Export</span><span class=o>*</span><span class=p>)(</span><span class=n>I</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>DTRACE_GLOBAL_CALL_FROM_EXPORT</span><span class=p>(</span><span class=n>c_p</span><span class=p>,</span> <span class=n>ep</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>SET_I</span><span class=p>(</span><span class=n>ep</span><span class=o>-&gt;</span><span class=n>dispatch</span><span class=p>.</span><span class=n>addresses</span><span class=p>[</span><span class=nf>erts_active_code_ix</span><span class=p>()]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>CHECK_ARGS</span><span class=p>(</span><span class=n>I</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>dis_next</span> <span class=o>=</span> <span class=o>*</span><span class=n>I</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>ERTS_UNLIKELY</span><span class=p>(</span><span class=n>FCALLS</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nf>ERTS_PROC_GET_SAVED_CALLS_BUF</span><span class=p>(</span><span class=n>c_p</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>FCALLS</span> <span class=o>&gt;</span> <span class=n>neg_o_reds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>save_calls</span><span class=p>(</span><span class=n>c_p</span><span class=p>,</span> <span class=n>ep</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=n>context_switch</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>FCALLS</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>Goto</span><span class=p>(</span><span class=n>dis_next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=nf>ASSERT</span><span class=p>(</span><span class=o>!</span><span class=s>&#34;Fell through &#39;i_call_ext_last&#39; (-no_next)&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>Export</code>导出结构和<code>erts_active_code_ix</code>激活代码地址索引是我们想要了解的</p><h2 id=两个代码相关的核心模块>两个代码相关的核心模块</h2><h2 id=erts_code_purgererlhttpsgithubcomerlangotpblobmaint-24ertspreloadedsrcerts_code_purgererl><a href=https://github.com/erlang/otp/blob/maint-24/erts/preloaded/src/erts_code_purger.erl>erts_code_purger.erl</a></h2><ul><li>硬清理 <a href=https://github.com/erlang/otp/blob/maint-24/erts/preloaded/src/erts_code_purger.erl#L117>erts_code_purger:purge/2</a></li><li>软清理 <a href=https://github.com/erlang/otp/blob/maint-24/erts/preloaded/src/erts_code_purger.erl#L114>erts_code_purger:soft_purge/2</a></li><li>清理接口<a href=erts/emulator/beam/beam_bif_load.c>erts_internal_purge_module_2</a></li></ul><blockquote><p>清理接口主要检测是否有进程正在占用当前代码</p></blockquote><blockquote><p>清理主要分两步，prepare和abort/complete</p></blockquote><blockquote><p>硬清理和软清理区别在于是否终止正在使用此代码的进程</p></blockquote><h2 id=codeerlhttpsgithubcomerlangotpblobmaint-24libkernelsrccodeerl><a href=https://github.com/erlang/otp/blob/maint-24/lib/kernel/src/code.erl>code.erl</a></h2><ul><li>加载文件(模块) <a href=https://github.com/erlang/otp/blob/maint-24/lib/kernel/src/code_server.erl#L1155>code_server:load_file/3</a></li><li>加载模块服务管理 <a href=https://github.com/erlang/otp/blob/maint-24/lib/kernel/src/code_server.erl#L1127-L1138>code_server:try_load_module_2/6</a></li><li>加载模块接口 <a href=https://github.com/erlang/otp/blob/maint-24/erts/preloaded/src/erlang.erl#L2514-L2529>erlang:load_module/2</a></li></ul><h2 id=两个核心函数>两个核心函数</h2><h3 id=erlangprepare_loading2httpsgithubcomerlangotpblobmaint-24liberlanglibertssrcerlangerll1689><a href=https://github.com/erlang/otp/blob/maint-24/lib/erlang/lib/erts/src/erlang.erl#L1689>erlang:prepare_loading/2</a></h3><ul><li>包装函数 <a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/beam_bif_load.c#L246>erts_internal_prepare_loading_2</a></li><li>主函数 <a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/beam_load.c#L107>erts_prepare_loading</a></li><li>读取(解码)字节码 <a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/beam_file.c#L727>beamfile_read</a></li><li>加载字节码 <a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/beam_load.c#L362>load_code</a></li></ul><blockquote><p>加载阶段主要就是检查字节码有效性并加载到内存中</p></blockquote><h3 id=erlangfinish_loading1httpsgithubcomerlangotpblobmaint-24ertspreloadedsrcerlangerll978><a href=https://github.com/erlang/otp/blob/maint-24/erts/preloaded/src/erlang.erl#L978>erlang:finish_loading/1</a></h3><ul><li>检查权限/是否正在加载/是否被清理过等 <a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/beam_bif_load.c#L333>finish_loading_1</a></li><li>加载模块 <a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/beam_load.c#L190>finish_loading_1</a></li></ul><blockquote><p>代码<a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/beam_load.c#L208><code>beam_make_current_old</code></a>是把当前数据移动到旧数据</p></blockquote><blockquote><p>代码<a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/beam_load.c#L221><code>export_list</code></a>正是导出函数功能</p></blockquote><blockquote><p>代码<a href=https://github.com/erlang/otp/blob/maint-24/erts/emulator/beam/beam_load.c#L235-l236><code>trampoline</code></a>是切换暂存地址到激活地址</p></blockquote><blockquote><p>同一个模块有两份数据，一份正在(激活)使用，一份旧(副本)数据。如果旧数据正在被进程占用，<a href=https://github.com/erlang/otp/blob/maint-24/erts/preloaded/src/erts_code_purger.erl#L114><code>soft_purge</code></a>不能清理旧代码，也就说无法进行热更新新的代码</p></blockquote></div><div class=post_footer></div></div><div class=doc_comments><div class=comments_block_title>发表评论</div><div id=comments></div></div><style>.giscus,.giscus-frame{margin-bottom:48px}</style><script src=https://giscus.app/client.js data-repo=QCute/qcute.github.io data-repo-id=R_kgDOG-5qXQ data-category=Announcements data-category-id=DIC_kwDOG-5qXc4CSRb_ data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>轻作、重拾写作的乐趣</span></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script src=/js/graphite.min.js></script><script type=text/javascript id=MathJax-script async src=https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js></script><script>MathJax={options:{skipHtmlTags:["script","noscript","style","textarea","pre"]},tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0}}</script></body></html>