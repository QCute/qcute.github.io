<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><title>某实时公交API ｜ 轻作</title>
<meta name=description content=" API <?php class BusComing { /** Construct * @date 2022/03/20 * * @param string $userId * @param string $h5Id */ public function __construct(string $userId = '', string $h5Id = '') { $this->userId = $userId; // the h5Id default userId $this->h5Id = empty($h5Id) ? $userId : $h5Id; // user agent $this->userAgent = 'Mozilla/5.0 (Linux; Android 10; MI 6 Build/PKQ1.190118.001; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/88.0.0000.00 XWEB/3193 MMWEBSDK/20220202 Mobile Safari/537.36 MMWEBID/5374 MicroMessenger/8.0.20.2100(0x28001437) Process/appbrand1 WeChat/arm64 Weixin NetType/WIFI Language/zh_CN ABI/arm64 MiniProgramEnv/android'; } /** Set user agent * * @param string $userAgent */ public function setUserAgent(string $userAgent = '') { $this->userAgent = $userAgent; } /** cURL request * * @param string $url * @param array $header * @param string $userAgent * @param string $proxy * * @return string */ private static function curl(string $url = '', array $header = [], string $userAgent = '', string $proxy = ''): string { // parse header $header = array_map(function ($key, $value) { return $key . ':' . $value; }, array_keys($header), $header); // curl $curl = curl_init(); curl_setopt($curl, CURLOPT_URL, $url); curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, FALSE); curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, FALSE); curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); curl_setopt($curl, CURLOPT_HTTPHEADER, $header); curl_setopt($curl, CURLOPT_PROXY, $proxy); curl_setopt($curl, CURLOPT_USERAGENT, $userAgent); curl_setopt($curl, CURLOPT_ENCODING, 'gzip,deflate'); $output = curl_exec($curl); curl_close($curl); return $output; } /** Search buses/lines detail * * @param array $param * @param string $proxy * * @return array */ public function searchLines(array $param = [], $proxy = ''): array { $preset = [ 's' => 'h5', 'wxs' => 'wx_app', 'sign' => '1', 'h5RealData' => '1', 'v' => '4.0.00', 'src' => 'weixinapp_cx', 'ctm_mp' => 'mp_wx', 'vc' => '1', 'cityId' => '040', // not 020 in canton, so strange 'favoriteGray' => '0', 'userId' => $this->userId, 'h5Id' => $this->h5Id, 'lat' => '23.123603', // latitude 'lng' => '113.384541', // longitude 'geo_lat' => '23.123603', // geo latitude => lat 'geo_lng' => '113.384541', // geo longitude => lng 'gpstype' => 'wgs', 'geo_type' => 'wgs', 'scene' => '1006', 'localCityId' => '040', // not 020 in canton, so strange 'key' => '28', 'poiNum' => '0', ]; // merge params $param = array_merge($preset, $param); // parse params $param = array_map(function ($key, $value) { return $key . '=' . $value; }, array_keys($param), $param); $url = 'https://web.chelaile.net.cn/api/bus/query!nSearch.action?' . implode('&', $param); $header = [ 'Connection' => 'keep-alive', 'charset' => 'utf-8', 'content-type' => 'text', 'Accept-Encoding' => 'gzip,compress,br,deflate', 'Referer' => 'https://servicewechat.com/wx71d589ea01ce3321/543/page-frame.html', ]; $string = self::curl($url, $header, $this->userAgent, $proxy); // example **YGJK{}YGJK## $json = json_decode(substr(substr($string, 6), 0, -6), true) ?? ['jsonr' => ['data' => ['result' => []], 'status' => '00']]; return $json['jsonr']['data']['result']; } /** Get line detail * * @param array $param * @param string $proxy * * @return array */ public function getLineDetail(array $param = [], $proxy = ''): array { $preset = [ 's' => 'h5', 'wxs' => 'wx_app', 'sign' => '1', 'h5RealData' => '1', 'v' => '4.0.00', // version 'src' => 'weixinapp_cx', 'ctm_mp' => 'mp_wx', 'vc' => '1', 'cityId' => '040', // not 020 in canton, so strange 'favoriteGray' => '0', 'userId' => $this->userId, 'h5Id' => $this->h5Id, 'lat' => '23.123603', // latitude 'lng' => '113.384541', // longitude 'geo_lat' => '23.123603', // geo latitude => lat 'geo_lng' => '113.384541', // geo longitude => lng 'gpstype' => 'wgs', 'geo_type' => 'wgs', 'scene' => '1001', 'lineId' => '020-00280-1', // cityId-lineId-order(forward: 0/backward: 1) 'targetOrder' => '1', // station order 'special' => '0', 'specialOrder' => '1', // station order 'specialType' => 'undefined', 'specialTargetOrder' => '1', // station order 'stationId' => '020-18462', // bus station id 'grey_city' => '1', 'localCityId' => '040', // not 020 in canton, so strange 'permission' => '0', 'cryptoSign' => 'd4f6d9ba4bd88dc8c8070de0aeb72e74', ]; // merge params $param = array_merge($preset, $param); // parse params $param = array_map(function ($key, $value) { return $key . '=' . $value; }, array_keys($param), $param); $url = 'https://web.chelaile.net.cn/api/bus/line!encryptedLineDetail.action?' . implode('&', $param); $header = [ 'Connection' => 'keep-alive', 'charset' => 'utf-8', 'content-type' => 'text', 'Accept-Encoding' => 'gzip,compress,br,deflate', 'Referer' => 'https://servicewechat.com/wx71d589ea01ce3321/543/page-frame.html', ]; $string = self::curl($url, $header, $this->userAgent, $proxy); // example **YGJK{}YGJK## $json = json_decode(substr(substr($string, 6), 0, -6), true) ?? ['jsonr' => ['data' => ['encryptResult' => ''], 'status' => '00']]; $data = $json['jsonr']['data']; // mode and key take from fetcher.encrypt.js in wechat mini app $string = openssl_decrypt($data['encryptResult'], 'aes-256-ecb', 'FF32AE65FBFD19414EAAFF6291A54B42'); return json_decode($string, true) ?? []; } /** Get buses detail * * @param array $param * @param string $proxy * * @return array */ public function getBusesDetail(array $param = [], $proxy = ''): array { $preset = [ 's' => 'h5', 'wxs' => 'wx_app', 'sign' => '1', 'h5RealData' => '1', 'v' => '4.0.00', // version 'src' => 'weixinapp_cx', 'ctm_mp' => 'mp_wx', 'vc' => '1', 'cityId' => '040', // not 020 in canton, so strange 'favoriteGray' => '0', 'userId' => $this->userId, 'h5Id' => $this->h5Id, 'lat' => '23.123603', // latitude 'lng' => '113.384541', // longitude 'geo_lat' => '23.123603', // geo latitude => lat 'geo_lng' => '113.384541', // geo longitude => lng 'gpstype' => 'wgs', 'geo_type' => 'wgs', 'scene' => '1001', 'lineId' => '020-00280-1', // cityId-lineId-order(forward: 0/backward: 1) 'targetOrder' => '1', 'specialTargetOrder' => '1', 'specail' => '0', 'stationId' => '020-4608', // bus station id 'specialType' => 'undefined', 'cshow' => 'busDetail', ]; // merge params $param = array_merge($preset, $param); // parse params $param = array_map(function ($key, $value) { return $key . '=' . $value; }, array_keys($param), $param); $url = 'https://web.chelaile.net.cn/api/bus/line!busesDetail.action?' . implode('&', $param); $header = [ 'Connection' => 'keep-alive', 'charset' => 'utf-8', 'content-type' => 'text', 'Accept-Encoding' => 'gzip,compress,br,deflate', 'Referer' => 'https://servicewechat.com/wx71d589ea01ce3321/543/page-frame.html', ]; $string = self::curl($url, $header, $this->userAgent, $proxy); // example **YGJK{}YGJK## $json = json_decode(substr(substr($string, 6), 0, -6), true) ?? ['jsonr' => ['data' => [], 'status' => '00']]; return $json['jsonr']['data']; } } 使用 echo &#34;<pre>&#34;; $bus = new BusComing('okBHq0ETXAjgKH5HcIltsNaV3Lsk'); echo &#34;result of buses/lines: <br/>&#34;; // lines 线路信息 print_r($bus->searchLines()); echo &#34;line detail: <br/>&#34;; // stations 站点信息 print_r($bus->getLineDetail()); echo &#34;bus detail: <br/>&#34;; // buses 公交信息 print_r($bus->getBusesDetail()); echo &#34;</pre>&#34;; PHP依赖 cURL模块 OpenSSL模块
"><meta name=keywords content="Hugo,theme,graphite"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=apple-touch-icon type=image/x-icon href=/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.0.1/remixicon.css><link rel=stylesheet type=text/css media=screen href=/css/highlight.min.css><link rel=stylesheet type=text/css media=screen href=/css/graphite.min.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>首页</a></li><li><a href=/categories/>分类</a></li><li><a href=/tags/>标签</a></li><li><a href=/posts/>归档</a></li><li><a href=/about/>关于</a></li><li><a href=/search/ title=搜索 id=site_search><i class=ri-search-line></i></a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://qcute.github.io/><span><img src=/images/favicon.ico></span></a></h1></div><div class=description><h1 style=float:right><a><span>轻作</span></a></h1><br><br><p class=sub_title>重拾写作的乐趣</p><div class=my_socials><a href type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/misc/bus-coming/>某实时公交API</a></h2><span class=date>2020.03.07</span></div><div class="post_content markdown"><ul><li>API</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BusComing</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/** Construct
</span></span></span><span class=line><span class=cl><span class=sd>     * @date 2022/03/20
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @param string $userId
</span></span></span><span class=line><span class=cl><span class=sd>     * @param string $h5Id
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$userId</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$h5Id</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userId</span> <span class=o>=</span> <span class=nv>$userId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// the h5Id default userId
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>h5Id</span> <span class=o>=</span> <span class=k>empty</span><span class=p>(</span><span class=nv>$h5Id</span><span class=p>)</span> <span class=o>?</span> <span class=nv>$userId</span> <span class=o>:</span> <span class=nv>$h5Id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// user agent
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userAgent</span> <span class=o>=</span> <span class=s1>&#39;Mozilla/5.0 (Linux; Android 10; MI 6 Build/PKQ1.190118.001; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/88.0.0000.00 XWEB/3193 MMWEBSDK/20220202 Mobile Safari/537.36 MMWEBID/5374 MicroMessenger/8.0.20.2100(0x28001437) Process/appbrand1 WeChat/arm64 Weixin NetType/WIFI Language/zh_CN ABI/arm64 MiniProgramEnv/android&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/** Set user agent
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @param string $userAgent
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>setUserAgent</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$userAgent</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userAgent</span> <span class=o>=</span> <span class=nv>$userAgent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/** cURL request
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @param string $url
</span></span></span><span class=line><span class=cl><span class=sd>     * @param array $header
</span></span></span><span class=line><span class=cl><span class=sd>     * @param string $userAgent
</span></span></span><span class=line><span class=cl><span class=sd>     * @param string $proxy
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @return string
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>private</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>curl</span><span class=p>(</span><span class=nx>string</span> <span class=nv>$url</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=k>array</span> <span class=nv>$header</span> <span class=o>=</span> <span class=p>[],</span> <span class=nx>string</span> <span class=nv>$userAgent</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nx>string</span> <span class=nv>$proxy</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>:</span> <span class=nx>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// parse header
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$header</span> <span class=o>=</span> <span class=nx>array_map</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nv>$key</span><span class=p>,</span> <span class=nv>$value</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=nv>$key</span> <span class=o>.</span> <span class=s1>&#39;:&#39;</span> <span class=o>.</span> <span class=nv>$value</span><span class=p>;</span> <span class=p>},</span> <span class=nx>array_keys</span><span class=p>(</span><span class=nv>$header</span><span class=p>),</span> <span class=nv>$header</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// curl
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$curl</span> <span class=o>=</span> <span class=nx>curl_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_URL</span><span class=p>,</span> <span class=nv>$url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_SSL_VERIFYPEER</span><span class=p>,</span> <span class=k>FALSE</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_SSL_VERIFYHOST</span><span class=p>,</span> <span class=k>FALSE</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_RETURNTRANSFER</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_HTTPHEADER</span><span class=p>,</span> <span class=nv>$header</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_PROXY</span><span class=p>,</span> <span class=nv>$proxy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_USERAGENT</span><span class=p>,</span> <span class=nv>$userAgent</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_setopt</span><span class=p>(</span><span class=nv>$curl</span><span class=p>,</span> <span class=nx>CURLOPT_ENCODING</span><span class=p>,</span> <span class=s1>&#39;gzip,deflate&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$output</span> <span class=o>=</span> <span class=nx>curl_exec</span><span class=p>(</span><span class=nv>$curl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>curl_close</span><span class=p>(</span><span class=nv>$curl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$output</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/** Search buses/lines detail
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @param array $param
</span></span></span><span class=line><span class=cl><span class=sd>     * @param string $proxy
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @return array
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>searchLines</span><span class=p>(</span><span class=k>array</span> <span class=nv>$param</span> <span class=o>=</span> <span class=p>[],</span> <span class=nv>$proxy</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>:</span> <span class=k>array</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$preset</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;s&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;h5&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;wxs&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;wx_app&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sign&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;h5RealData&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;v&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;4.0.00&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;src&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;weixinapp_cx&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ctm_mp&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;mp_wx&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;vc&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cityId&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;040&#39;</span><span class=p>,</span>             <span class=c1>// not 020 in canton, so strange
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;favoriteGray&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;userId&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;h5Id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>h5Id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;lat&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;23.123603&#39;</span><span class=p>,</span>          <span class=c1>// latitude
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;lng&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;113.384541&#39;</span><span class=p>,</span>         <span class=c1>// longitude
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;geo_lat&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;23.123603&#39;</span><span class=p>,</span>      <span class=c1>// geo latitude =&gt; lat
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;geo_lng&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;113.384541&#39;</span><span class=p>,</span>     <span class=c1>// geo longitude =&gt; lng
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;gpstype&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;wgs&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;geo_type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;wgs&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;scene&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1006&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;localCityId&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;040&#39;</span><span class=p>,</span>        <span class=c1>// not 020 in canton, so strange
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;key&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;28&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;poiNum&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=c1>// merge params
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$param</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span><span class=nv>$preset</span><span class=p>,</span> <span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// parse params
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$param</span> <span class=o>=</span> <span class=nx>array_map</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nv>$key</span><span class=p>,</span> <span class=nv>$value</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=nv>$key</span> <span class=o>.</span> <span class=s1>&#39;=&#39;</span> <span class=o>.</span> <span class=nv>$value</span><span class=p>;</span> <span class=p>},</span> <span class=nx>array_keys</span><span class=p>(</span><span class=nv>$param</span><span class=p>),</span> <span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$url</span> <span class=o>=</span> <span class=s1>&#39;https://web.chelaile.net.cn/api/bus/query!nSearch.action?&#39;</span> <span class=o>.</span> <span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;&amp;&#39;</span><span class=p>,</span> <span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$header</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Connection&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;keep-alive&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;charset&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;content-type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Accept-Encoding&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;gzip,compress,br,deflate&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Referer&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;https://servicewechat.com/wx71d589ea01ce3321/543/page-frame.html&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nv>$string</span> <span class=o>=</span> <span class=nx>self</span><span class=o>::</span><span class=na>curl</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nv>$header</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userAgent</span><span class=p>,</span> <span class=nv>$proxy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// example **YGJK{}YGJK##
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$json</span> <span class=o>=</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$string</span><span class=p>,</span> <span class=mi>6</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>6</span><span class=p>),</span> <span class=k>true</span><span class=p>)</span> <span class=o>??</span> <span class=p>[</span><span class=s1>&#39;jsonr&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;data&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;result&#39;</span> <span class=o>=&gt;</span> <span class=p>[]],</span> <span class=s1>&#39;status&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;00&#39;</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$json</span><span class=p>[</span><span class=s1>&#39;jsonr&#39;</span><span class=p>][</span><span class=s1>&#39;data&#39;</span><span class=p>][</span><span class=s1>&#39;result&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=sd>/** Get line detail
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @param array $param
</span></span></span><span class=line><span class=cl><span class=sd>     * @param string $proxy
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @return array
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>getLineDetail</span><span class=p>(</span><span class=k>array</span> <span class=nv>$param</span> <span class=o>=</span> <span class=p>[],</span> <span class=nv>$proxy</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>:</span> <span class=k>array</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$preset</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;s&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;h5&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;wxs&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;wx_app&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sign&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;h5RealData&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;v&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;4.0.00&#39;</span><span class=p>,</span>               <span class=c1>// version
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;src&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;weixinapp_cx&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ctm_mp&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;mp_wx&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;vc&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cityId&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;040&#39;</span><span class=p>,</span>             <span class=c1>// not 020 in canton, so strange
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;favoriteGray&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;userId&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;h5Id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>h5Id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;lat&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;23.123603&#39;</span><span class=p>,</span>          <span class=c1>// latitude
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;lng&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;113.384541&#39;</span><span class=p>,</span>         <span class=c1>// longitude
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;geo_lat&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;23.123603&#39;</span><span class=p>,</span>      <span class=c1>// geo latitude =&gt; lat
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;geo_lng&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;113.384541&#39;</span><span class=p>,</span>     <span class=c1>// geo longitude =&gt; lng
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;gpstype&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;wgs&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;geo_type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;wgs&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;scene&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1001&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;lineId&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;020-00280-1&#39;</span><span class=p>,</span>     <span class=c1>// cityId-lineId-order(forward: 0/backward: 1)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;targetOrder&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>          <span class=c1>// station order
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;special&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;specialOrder&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>         <span class=c1>// station order
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;specialType&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;undefined&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;specialTargetOrder&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>   <span class=c1>// station order
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;stationId&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;020-18462&#39;</span><span class=p>,</span>    <span class=c1>// bus station id
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;grey_city&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;localCityId&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;040&#39;</span><span class=p>,</span>        <span class=c1>// not 020 in canton, so strange
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;permission&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cryptoSign&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;d4f6d9ba4bd88dc8c8070de0aeb72e74&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=c1>// merge params
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$param</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span><span class=nv>$preset</span><span class=p>,</span> <span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// parse params
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$param</span> <span class=o>=</span> <span class=nx>array_map</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nv>$key</span><span class=p>,</span> <span class=nv>$value</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=nv>$key</span> <span class=o>.</span> <span class=s1>&#39;=&#39;</span> <span class=o>.</span> <span class=nv>$value</span><span class=p>;</span> <span class=p>},</span> <span class=nx>array_keys</span><span class=p>(</span><span class=nv>$param</span><span class=p>),</span> <span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$url</span> <span class=o>=</span> <span class=s1>&#39;https://web.chelaile.net.cn/api/bus/line!encryptedLineDetail.action?&#39;</span> <span class=o>.</span> <span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;&amp;&#39;</span><span class=p>,</span> <span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$header</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Connection&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;keep-alive&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;charset&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;content-type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Accept-Encoding&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;gzip,compress,br,deflate&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Referer&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;https://servicewechat.com/wx71d589ea01ce3321/543/page-frame.html&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nv>$string</span> <span class=o>=</span> <span class=nx>self</span><span class=o>::</span><span class=na>curl</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nv>$header</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userAgent</span><span class=p>,</span> <span class=nv>$proxy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// example **YGJK{}YGJK##
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$json</span> <span class=o>=</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$string</span><span class=p>,</span> <span class=mi>6</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>6</span><span class=p>),</span> <span class=k>true</span><span class=p>)</span> <span class=o>??</span> <span class=p>[</span><span class=s1>&#39;jsonr&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;data&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;encryptResult&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span><span class=p>],</span> <span class=s1>&#39;status&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;00&#39;</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>        <span class=nv>$data</span> <span class=o>=</span> <span class=nv>$json</span><span class=p>[</span><span class=s1>&#39;jsonr&#39;</span><span class=p>][</span><span class=s1>&#39;data&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=c1>// mode and key take from fetcher.encrypt.js in wechat mini app
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$string</span> <span class=o>=</span> <span class=nx>openssl_decrypt</span><span class=p>(</span><span class=nv>$data</span><span class=p>[</span><span class=s1>&#39;encryptResult&#39;</span><span class=p>],</span> <span class=s1>&#39;aes-256-ecb&#39;</span><span class=p>,</span> <span class=s1>&#39;FF32AE65FBFD19414EAAFF6291A54B42&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nv>$string</span><span class=p>,</span> <span class=k>true</span><span class=p>)</span> <span class=o>??</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=sd>/** Get buses detail
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @param array $param
</span></span></span><span class=line><span class=cl><span class=sd>     * @param string $proxy
</span></span></span><span class=line><span class=cl><span class=sd>     * 
</span></span></span><span class=line><span class=cl><span class=sd>     * @return array
</span></span></span><span class=line><span class=cl><span class=sd>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>function</span> <span class=nf>getBusesDetail</span><span class=p>(</span><span class=k>array</span> <span class=nv>$param</span> <span class=o>=</span> <span class=p>[],</span> <span class=nv>$proxy</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>)</span><span class=o>:</span> <span class=k>array</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nv>$preset</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;s&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;h5&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;wxs&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;wx_app&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sign&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;h5RealData&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;v&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;4.0.00&#39;</span><span class=p>,</span>               <span class=c1>// version
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;src&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;weixinapp_cx&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ctm_mp&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;mp_wx&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;vc&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cityId&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;040&#39;</span><span class=p>,</span>             <span class=c1>// not 020 in canton, so strange
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;favoriteGray&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;userId&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;h5Id&#39;</span> <span class=o>=&gt;</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>h5Id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;lat&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;23.123603&#39;</span><span class=p>,</span>          <span class=c1>// latitude
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;lng&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;113.384541&#39;</span><span class=p>,</span>         <span class=c1>// longitude
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;geo_lat&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;23.123603&#39;</span><span class=p>,</span>      <span class=c1>// geo latitude =&gt; lat
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;geo_lng&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;113.384541&#39;</span><span class=p>,</span>     <span class=c1>// geo longitude =&gt; lng
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;gpstype&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;wgs&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;geo_type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;wgs&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;scene&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1001&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;lineId&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;020-00280-1&#39;</span><span class=p>,</span>     <span class=c1>// cityId-lineId-order(forward: 0/backward: 1)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;targetOrder&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;specialTargetOrder&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;specail&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;0&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;stationId&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;020-4608&#39;</span><span class=p>,</span>     <span class=c1>// bus station id
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=s1>&#39;specialType&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;undefined&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cshow&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;busDetail&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=c1>// merge params
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$param</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span><span class=nv>$preset</span><span class=p>,</span> <span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// parse params
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$param</span> <span class=o>=</span> <span class=nx>array_map</span><span class=p>(</span><span class=k>function</span> <span class=p>(</span><span class=nv>$key</span><span class=p>,</span> <span class=nv>$value</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=nv>$key</span> <span class=o>.</span> <span class=s1>&#39;=&#39;</span> <span class=o>.</span> <span class=nv>$value</span><span class=p>;</span> <span class=p>},</span> <span class=nx>array_keys</span><span class=p>(</span><span class=nv>$param</span><span class=p>),</span> <span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$url</span> <span class=o>=</span> <span class=s1>&#39;https://web.chelaile.net.cn/api/bus/line!busesDetail.action?&#39;</span> <span class=o>.</span> <span class=nx>implode</span><span class=p>(</span><span class=s1>&#39;&amp;&#39;</span><span class=p>,</span> <span class=nv>$param</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nv>$header</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Connection&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;keep-alive&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;charset&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;content-type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;text&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Accept-Encoding&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;gzip,compress,br,deflate&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Referer&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;https://servicewechat.com/wx71d589ea01ce3321/543/page-frame.html&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nv>$string</span> <span class=o>=</span> <span class=nx>self</span><span class=o>::</span><span class=na>curl</span><span class=p>(</span><span class=nv>$url</span><span class=p>,</span> <span class=nv>$header</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userAgent</span><span class=p>,</span> <span class=nv>$proxy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// example **YGJK{}YGJK##
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nv>$json</span> <span class=o>=</span> <span class=nx>json_decode</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nx>substr</span><span class=p>(</span><span class=nv>$string</span><span class=p>,</span> <span class=mi>6</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>6</span><span class=p>),</span> <span class=k>true</span><span class=p>)</span> <span class=o>??</span> <span class=p>[</span><span class=s1>&#39;jsonr&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span><span class=s1>&#39;data&#39;</span> <span class=o>=&gt;</span> <span class=p>[],</span> <span class=s1>&#39;status&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;00&#39;</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nv>$json</span><span class=p>[</span><span class=s1>&#39;jsonr&#39;</span><span class=p>][</span><span class=s1>&#39;data&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li>使用</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;&lt;pre&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$bus</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BusComing</span><span class=p>(</span><span class=s1>&#39;okBHq0ETXAjgKH5HcIltsNaV3Lsk&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;result of buses/lines: &lt;br/&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// lines 线路信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>print_r</span><span class=p>(</span><span class=nv>$bus</span><span class=o>-&gt;</span><span class=na>searchLines</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;line detail: &lt;br/&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// stations 站点信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>print_r</span><span class=p>(</span><span class=nv>$bus</span><span class=o>-&gt;</span><span class=na>getLineDetail</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;bus detail: &lt;br/&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// buses 公交信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>print_r</span><span class=p>(</span><span class=nv>$bus</span><span class=o>-&gt;</span><span class=na>getBusesDetail</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;&lt;/pre&gt;&#34;</span><span class=p>;</span>
</span></span></code></pre></div><ul><li><a href=https://www.php.net>PHP</a>依赖</li></ul><blockquote><p><a href=https://www.php.net/manual/en/book.curl.php>cURL</a>模块
<a href=https://www.php.net/manual/en/book.openssl.php>OpenSSL</a>模块</p></blockquote></div><div class=post_footer></div></div><div class=doc_comments><div class=comments_block_title>发表评论</div><div id=comments></div></div><style>.giscus,.giscus-frame{margin-bottom:48px}</style><script src=https://giscus.app/client.js data-repo=QCute/qcute.github.io data-repo-id=R_kgDOG-5qXQ data-category=Announcements data-category-id=DIC_kwDOG-5qXc4CSRb_ data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>轻作、重拾写作的乐趣</span></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script src=/js/graphite.min.js></script><script type=text/javascript id=MathJax-script async src=https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js></script><script>MathJax={options:{skipHtmlTags:["script","noscript","style","textarea","pre"]},tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0}}</script></body></html>