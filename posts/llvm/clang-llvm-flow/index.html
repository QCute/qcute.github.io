<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="QCute"><title>Clang/LLVM编译流程 ｜ 轻作</title>
<meta name=description content='1 .c(源文件) -> .i(预处理文件) clang -E -c test.c -o test.i 1.1 .c(源文件) -> .bc(LLVM IR文件(二进制形式)) clang -emit-llvm test.c -c -o test.bc 1.2 .c(源文件) -> .ll(LLVM IR文件(文本形式)) clang -emit-llvm test.c -S -o test.ll 2 .i(预处理文件) -> .bc(LLVM IR文件(二进制形式)) clang -emit-llvm test.i -c -o test.bc 2.1 .i(预处理文件) -> .ll(LLVM IR文件(文本形式)) clang -emit-llvm test.i -S -o test.ll 2.2 .bc(LLVM IR文件(二进制形式)) -> .ll(LLVM IR文件(文本形式)) llvm-dis test.bc -o test.ll 2.3 .ll(LLVM IR文件(文本形式)) -> .bc(LLVM IR文件(二进制形式)) llvm-as test.ll -o test.bc 2.4 把多个 .bc 合并为一个 .bc llvm-link test1.bc test2.bc -o test.bc 3 .bc(LLVM IR文件(二进制形式)) -> .s(汇编文件) llc --march=x86-64 test.bc 4 .s(汇编文件) -> .o(可重定位的对象文件) clang -c test.s -o test.o 5 .o(可重定位的对象文件) -> elf(可执行文件) ld.lld -e main -o test test.o 5.1 不链接C库需要手动退出，在main函数返回前进行系统调用 // x86-linux asm( "movq $0, %rdi \n\t" "movq $1, %rax \n\t" "syscall \n\t" ); // x64-linux asm( "movq $0, %rdi \n\t" "movq $60, %rax \n\t" "syscall \n\t" ); 5.2 如果使用了C API则需要链接C库 # Debian/Ubuntu ld.lld -dynamic-linker /lib64/ld-linux-x86-64.so.2 -o test test.o /lib/x86_64-linux-gnu/crt1.o /lib/x86_64-linux-gnu/crti.o /lib/x86_64-linux-gnu/crtn.o /lib/x86_64-linux-gnu/libc.so # RedHat/CentOS/RockyLinux ld.lld -dynamic-linker /lib64/ld-linux-x86-64.so.2 -o test test.o /lib64/crt1.o /lib64/crti.o /lib64/crtn.o /lib64/libc.so ll文件语法参考 LangRef
'><meta name=keywords content="Hugo,theme,graphite"><link rel=icon type=image/x-icon href=/images/favicon.ico><link rel=apple-touch-icon type=image/x-icon href=/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.0.1/remixicon.css><link rel=stylesheet type=text/css media=screen href=/css/highlight.min.css><link rel=stylesheet type=text/css media=screen href=/css/graphite.min.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>首页</a></li><li><a href=/categories/>分类</a></li><li><a href=/tags/>标签</a></li><li><a href=/posts/>归档</a></li><li><a href=/about/>关于</a></li><li><a href=/search/ title=搜索 id=site_search><i class=ri-search-line></i></a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://qcute.github.io/><span><img src=/images/favicon.ico></span></a></h1></div><div class=description><h1 style=float:right><a><span>轻作</span></a></h1><br><br><p class=sub_title>重拾写作的乐趣</p><div class=my_socials><a href=https://github.com/QCute title=github target=_blank><i class=ri-github-fill></i></a>
<a href=https://www.zhihu.com/people/tui-fei-er-you-ya-de-shen-shi title=zhihu target=_blank><i class=ri-zhihu-fill></i></a>
<a href type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/llvm/clang-llvm-flow/>Clang/LLVM编译流程</a></h2><span class=date>2020.03.06</span></div><div class="post_content markdown"><h1 id=1-c源文件---i预处理文件>1 <a href>.c</a>(源文件) -> <a href>.i</a>(预处理文件)</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>clang -E -c test.c -o test.i
</span></span></code></pre></div><ul><li><h3 id=11-c源文件---bcllvm-ir文件二进制形式>1.1 <a href>.c</a>(源文件) -> <a href>.bc</a>(LLVM IR文件(二进制形式))</h3></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>clang -emit-llvm test.c -c -o test.bc
</span></span></code></pre></div><ul><li><h3 id=12-c源文件---llllvm-ir文件文本形式>1.2 <a href>.c</a>(源文件) -> <a href>.ll</a>(LLVM IR文件(文本形式))</h3></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>clang -emit-llvm test.c -S -o test.ll
</span></span></code></pre></div><h1 id=2-i预处理文件---bcllvm-ir文件二进制形式>2 <a href>.i</a>(预处理文件) -> <a href>.bc</a>(LLVM IR文件(二进制形式))</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>clang -emit-llvm test.i -c -o test.bc
</span></span></code></pre></div><ul><li><h3 id=21-i预处理文件---llllvm-ir文件文本形式>2.1 <a href>.i</a>(预处理文件) -> <a href>.ll</a>(LLVM IR文件(文本形式))</h3></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>clang -emit-llvm test.i -S -o test.ll
</span></span></code></pre></div><ul><li><h3 id=22-bcllvm-ir文件二进制形式---llllvm-ir文件文本形式>2.2 <a href>.bc</a>(LLVM IR文件(二进制形式)) -> <a href>.ll</a>(LLVM IR文件(文本形式))</h3></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>llvm-dis test.bc -o test.ll
</span></span></code></pre></div><ul><li><h3 id=23-llllvm-ir文件文本形式---bcllvm-ir文件二进制形式>2.3 <a href>.ll</a>(LLVM IR文件(文本形式)) -> <a href>.bc</a>(LLVM IR文件(二进制形式))</h3></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>llvm-as test.ll -o test.bc
</span></span></code></pre></div><ul><li><h3 id=24-把多个-bc-合并为一个-bc>2.4 把多个 <a href>.bc</a> 合并为一个 <a href>.bc</a></h3></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>llvm-link test1.bc test2.bc -o test.bc
</span></span></code></pre></div><h1 id=3-bcllvm-ir文件二进制形式---s汇编文件>3 <a href>.bc</a>(LLVM IR文件(二进制形式)) -> <a href>.s</a>(汇编文件)</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>llc --march<span class=o>=</span>x86-64 test.bc
</span></span></code></pre></div><h1 id=4-s汇编文件---o可重定位的对象文件>4 <a href>.s</a>(汇编文件) -> <a href>.o</a>(可重定位的对象文件)</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>clang -c test.s -o test.o
</span></span></code></pre></div><h1 id=5-o可重定位的对象文件---elf可执行文件>5 <a href>.o</a>(可重定位的对象文件) -> <a href>elf</a>(可执行文件)</h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ld.lld -e main -o <span class=nb>test</span> test.o
</span></span></code></pre></div><ul><li><h3 id=51-不链接c库需要手动退出在main函数返回前进行系统调用>5.1 不链接C库需要手动退出，在<a href>main</a>函数返回前进行系统调用</h3></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// x86-linux
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>asm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;movq $0, %rdi </span><span class=se>\n\t</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;movq $1, %rax </span><span class=se>\n\t</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;syscall </span><span class=se>\n\t</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// x64-linux
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>asm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;movq $0, %rdi </span><span class=se>\n\t</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;movq $60, %rax </span><span class=se>\n\t</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;syscall </span><span class=se>\n\t</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></div><ul><li><h3 id=52-如果使用了c-api则需要链接c库>5.2 如果使用了C API则需要链接C库</h3></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Debian/Ubuntu
</span></span><span class=line><span class=cl>ld.lld -dynamic-linker /lib64/ld-linux-x86-64.so.2 -o test test.o /lib/x86_64-linux-gnu/crt1.o /lib/x86_64-linux-gnu/crti.o /lib/x86_64-linux-gnu/crtn.o /lib/x86_64-linux-gnu/libc.so
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># RedHat/CentOS/RockyLinux
</span></span><span class=line><span class=cl>ld.lld -dynamic-linker /lib64/ld-linux-x86-64.so.2 -o test test.o /lib64/crt1.o /lib64/crti.o /lib64/crtn.o /lib64/libc.so
</span></span></code></pre></div><h1 id=ll文件语法参考><a href>ll</a>文件语法参考</h1><blockquote><p><a href=https://llvm.org/docs/LangRef.html#module-structure>LangRef</a></p></blockquote></div><div class=post_footer></div></div><div class=doc_comments><div class=comments_block_title>发表评论</div><div id=comments></div></div><style>.giscus,.giscus-frame{margin-bottom:48px}</style><script src=https://giscus.app/client.js data-repo=QCute/qcute.github.io data-repo-id=R_kgDOG-5qXQ data-category=Announcements data-category-id=DIC_kwDOG-5qXc4CSRb_ data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>轻作、重拾写作的乐趣</span></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script src=/js/graphite.min.js></script><script type=text/javascript id=MathJax-script async src=https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js></script><script>MathJax={options:{skipHtmlTags:["script","noscript","style","textarea","pre"]},tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0}}</script></body></html>