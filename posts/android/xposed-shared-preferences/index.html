<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="VarKai"><title>Xposed XSharedPreferences在安卓N以后及解决方案 ｜ 轻作</title><meta name=description content="由于在Android 7 (SDK 24) 及以后 Context.MODE_WORLD_READABLE 被废弃 导致Xposed XSharedPreference不可用 使用RemotePreferences, 但是需要Context 使用Context.createDevic"><meta name=keywords content="Hugo,theme,graphite"><link rel="shortcut icon" href=https://qcute.github.io/images/favicon.ico><link rel=stylesheet type=text/css media=screen href=https://unpkg.com/normalize.css@8.0.1/normalize.css><link rel=stylesheet type=text/css media=screen href=https://unpkg.com/animate.css@4.1.1/animate.min.css><link rel=stylesheet type=text/css media=screen href=https://unpkg.com/remixicon@2.5.0/fonts/remixicon.css><link rel=stylesheet type=text/css media=screen href=https://unpkg.com/@fancyapps/ui@4.0.27/dist/fancybox.css><link rel=stylesheet type=text/css media=screen href=/css/highlight.min.css><link rel=stylesheet type=text/css media=screen href=/css/graphite.min.css></head><body><div class="main animate__animated animate__fadeInDown"><div class="nav_container animated fadeInDown"><div class=site_nav id=site_nav><ul><li><a href=/>首页</a></li><li><a href=/categories/>分类</a></li><li><a href=/tags/>标签</a></li><li><a href=/posts/>归档</a></li><li><a href=/about/>关于</a></li><li><a href=/search/ title=搜索 id=site_search><i class=ri-search-line></i></a></li></ul></div><div class=menu_icon><a id=menu_icon><i class=ri-menu-line></i></a></div></div><div class="header animated fadeInDown"><div class=site_title_container><div class=site_title><h1><a href=https://qcute.github.io/><span><img src=https://gohugo.io/favicon.ico></span></a></h1></div><div class=description><h1 style=float:right><a><span>轻作</span></a></h1><br><br><p class=sub_title>重拾写作的乐趣</p><div class=my_socials><a href=https://github.com/QCute title=github target=_blank><i class=ri-github-fill></i></a>
<a href=https://www.zhihu.com/people/tui-fei-er-you-ya-de-shen-shi title=zhihu target=_blank><i class=ri-zhihu-fill></i></a>
<a href=https://qcute.github.io/index.xml type=application/rss+xml title=rss target=_blank><i class=ri-rss-fill></i></a></div></div></div></div><div class=content><div class=post_page><div class="post animate__animated animate__fadeInDown"><div class="post_title post_detail_title"><h2><a href=/posts/android/xposed-shared-preferences/>Xposed XSharedPreferences在安卓N以后及解决方案</a></h2><span class=date>2020.03.03</span></div><div class="post_content markdown"><p>由于在<a href=https://www.android.com>Android</a> 7 (SDK 24) 及以后 <a href=https://developer.android.com/reference/android/content/Context#MODE_WORLD_READABLE>Context.MODE_WORLD_READABLE</a> 被废弃<br>导致<a href=https://repo.xposed.info/>Xposed</a> <a href=https://api.xposed.info/reference/de/robv/android/xposed/XSharedPreferences.html>XSharedPreference</a>不可用</p><ol><li><p>使用<a href=https://github.com/apsun/RemotePreferences>RemotePreferences</a>, 但是需要<a href=https://developer.android.com/reference/android/content/Context.html>Context</a></p></li><li><p>使用<a href=https://developer.android.com/reference/android/content/Context.html#createDeviceProtectedStorageContext()>Context.createDeviceProtectedStorageContext()</a><br>把文件储存到<a href>/data/user_de/0/包名/shared_prefs/名称.xml</a>, 然后再修复权限</p></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;ConstantConditions&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span> <span class=nf>getSharedPrefsPath</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>prefsPathCurrent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Field</span> <span class=n>fFile</span> <span class=o>=</span> <span class=n>prefs</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=s>&#34;mFile&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>fFile</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>prefsPathCurrent</span> <span class=o>=</span> <span class=o>((</span><span class=n>File</span><span class=o>)</span> <span class=n>fFile</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>prefs</span><span class=o>)).</span><span class=na>getParentFile</span><span class=o>().</span><span class=na>getAbsolutePath</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>prefsPathCurrent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>prefsPath</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>return</span> <span class=n>prefsPathCurrent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;ConstantConditions&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>String</span> <span class=nf>getSharedPrefsFile</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>prefsFileCurrent</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>Field</span> <span class=n>fFile</span> <span class=o>=</span> <span class=n>prefs</span><span class=o>.</span><span class=na>getClass</span><span class=o>().</span><span class=na>getDeclaredField</span><span class=o>(</span><span class=s>&#34;mFile&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>fFile</span><span class=o>.</span><span class=na>setAccessible</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>prefsFileCurrent</span> <span class=o>=</span> <span class=o>((</span><span class=n>File</span><span class=o>)</span> <span class=n>fFile</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>prefs</span><span class=o>)).</span><span class=na>getAbsolutePath</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>prefsFileCurrent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>prefsFile</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>return</span> <span class=n>prefsFileCurrent</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    
</span></span></code></pre></div><ul><li>摘自 <a href=https://github.com/liyafe1997/CustoMIUIzerMod/blob/mod/app/src/main/java/org/strawing/customiuizermod/utils/Helpers.java#L1600-L1624>CustoMIUIzerMod</a></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=nd>@SuppressLint</span><span class=o>({</span><span class=s>&#34;SetWorldReadable&#34;</span><span class=o>,</span> <span class=s>&#34;SetWorldWritable&#34;</span><span class=o>})</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>fixPermissionsAsync</span><span class=o>(</span><span class=n>Context</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>AsyncTask</span><span class=o>.</span><span class=na>execute</span><span class=o>(()</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>500</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Throwable</span> <span class=n>ignore</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>File</span> <span class=n>pkgFolder</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=na>getDataDir</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>pkgFolder</span><span class=o>.</span><span class=na>exists</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pkgFolder</span><span class=o>.</span><span class=na>setExecutable</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>pkgFolder</span><span class=o>.</span><span class=na>setReadable</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>pkgFolder</span><span class=o>.</span><span class=na>setWritable</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>File</span> <span class=n>sharedPrefsFolder</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>Helpers</span><span class=o>.</span><span class=na>getSharedPrefsPath</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>sharedPrefsFolder</span><span class=o>.</span><span class=na>exists</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>sharedPrefsFolder</span><span class=o>.</span><span class=na>setExecutable</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>sharedPrefsFolder</span><span class=o>.</span><span class=na>setReadable</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>sharedPrefsFolder</span><span class=o>.</span><span class=na>setWritable</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=n>File</span> <span class=n>sharedPrefsFile</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>Helpers</span><span class=o>.</span><span class=na>getSharedPrefsFile</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>sharedPrefsFile</span><span class=o>.</span><span class=na>exists</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=n>sharedPrefsFile</span><span class=o>.</span><span class=na>setReadable</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>sharedPrefsFile</span><span class=o>.</span><span class=na>setExecutable</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>                <span class=n>sharedPrefsFile</span><span class=o>.</span><span class=na>setWritable</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>});</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></div><ul><li>摘自 <a href=https://github.com/liyafe1997/CustoMIUIzerMod/blob/mod/app/src/main/java/org/strawing/customiuizermod/utils/Helpers.java#L1660-#L1686>CustoMIUIzerMod</a><br>但是此方法在 <a href=https://www.android.com>Android</a> 9 (SDK 28) 及以上的部分机型, 会因为Selinux的限制导致出现部分情况异常.</li></ul><ol start=3><li>如果运行在<a href=https://github.com/LSPosed/LSPosed>LSPosed</a>或者<a href=https://github.com/ElderDrivers/EdXposed>EdXposed</a>下, 可直接使用<a href=https://api.xposed.info/reference/de/robv/android/xposed/XSharedPreferences.html>XSharedPreferences</a></li></ol><ul><li>要求<a href=https://www.android.com>Android</a> 9 (SDK 28)及以上</li><li>要求<a href=https://api.xposed.info>XposedApi</a> xposedminversion 93及以上</li><li>会有兼容性问题, 例如, 不一定能在在<a href=https://taichi.cool/>太极</a>等框架上运行</li><li>在<a href=https://developer.android.com/guide/topics/manifest/manifest-intro>AndroidManifest.xml</a>中设置</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;meta-data</span> <span class=na>android:name=</span><span class=s>&#34;xposedminversion&#34;</span> <span class=na>android:value=</span><span class=s>&#34;93&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;meta-data</span> <span class=na>android:name=</span><span class=s>&#34;xposedsharedprefs&#34;</span> <span class=na>android:value=</span><span class=s>&#34;true&#34;</span> <span class=nt>/&gt;</span>
</span></span></code></pre></div><ul><li>参考</li></ul><blockquote><p>LSPosed： <a href=https://github.com/LSPosed/LSPosed/wiki/New-XSharedPreferences>New XSharedPreferences</a>
EdXposed： <a href=https://github.com/ElderDrivers/EdXposed/wiki/New-XSharedPreferences>New XSharedPreferences</a></p></blockquote><p>其他参考资料</p><blockquote><p><a href=https://blog.zhougy.top/2018/01/17/XSharedPreference_&_SharedPreference_-_XPosed%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84preference%E4%BD%BF%E7%94%A8/>XSharedPreference & SharedPreference - XPosed模块中的preference使用</a>
<a href=https://jasper1024.com/jasper/2323iuiowcsf/>Xposed&ndash;Android N 以上 XSharedPreferences</a></p></blockquote></div><div class=post_footer></div></div><div class=doc_comments><div class=comments_block_title>发表评论</div><div id=comments></div></div><style>.giscus,.giscus-frame{margin-bottom:48px}</style><script src=https://giscus.app/client.js data-repo=QCute/qcute.github.io data-repo-id=R_kgDOG-5qXQ data-category=Announcements data-category-id=DIC_kwDOG-5qXc4CSRb_ data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></div></div></div><a id=back_to_top href=# class=back_to_top><i class=ri-arrow-up-s-line></i></a><footer class=footer><div class=powered_by><a href=https://varkai.com>Designed by VarKai,</a>
<a href=http://www.gohugo.io/>Proudly published with Hugo</a></div><div class=footer_slogan><span>轻作、重拾写作的乐趣</span></div></footer><script src=https://unpkg.com/elevator.js@1.0.1/elevator.min.js></script>
<script src=https://unpkg.com/dom-slider@2.1.6/dist/dom-slider.js></script>
<script src=https://unpkg.com/@fancyapps/ui@4.0.27/dist/fancybox.umd.js></script>
<script src=/js/graphite.min.js></script>
<script>MathJax={options:{skipHtmlTags:["script","noscript","style","textarea","pre"]},tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0}}</script><script type=text/javascript id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js></script></body></html>